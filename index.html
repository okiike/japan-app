<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planificateur de Voyage Japon</title>
    <style>
        /* Styles généraux - Thème Sombre (Défaut initial, mais light est maintenant le défaut via JS) */
        :root {
            --bg-color: #1c1c1e; 
            --secondary-bg-color: #2c2c2e; 
            --tertiary-bg-color: #3a3a3c; 
            --text-color-primary: #ffffff; 
            --text-color-secondary: #e5e5ea; 
            --text-color-tertiary: #8e8e93; 
            --accent-color: #0a84ff; 
            --destructive-color: #ff3b30; 
            --highlight-color: #ff9f0a; 
            --food-button-color: #F39C12; /* Orange for food button */
            --border-color: #38383a; 
            --separator-color: #38383a; 
            --icon-color: var(--text-color-tertiary);
            --icon-active-color: var(--accent-color);
            --font-family-system: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        /* Thème Clair (Nouveau Défaut via JS) */
        body.theme-light {
            --bg-color: #f2f2f7;
            --secondary-bg-color: #ffffff;
            --tertiary-bg-color: #e5e5ea;
            --text-color-primary: #000000;
            --text-color-secondary: #3c3c43; 
            --text-color-tertiary: #8A8A8E; 
            --accent-color: #007aff; 
            --destructive-color: #ff3b30; 
            --highlight-color: #ff9500; 
            --food-button-color: #E67E22; 
            --border-color: #c6c6c8;
            --separator-color: #d1d1d6; 
            --icon-color: var(--text-color-tertiary);
            --icon-active-color: var(--accent-color);
        }
        body.theme-light .button { 
            color: #FFFFFF; 
        }
        body.theme-light .button.city-edit-icon-button { 
            background-color: var(--accent-color); 
            color: #FFFFFF;
        }
        body.theme-light .button.city-ai-activity-button { 
            background-color: var(--highlight-color); 
            color: #FFFFFF;
        }
        body.theme-light .button.suggest-food-button { 
            background-color: var(--food-button-color); 
            color: #FFFFFF;
        }
        body.theme-light .button.secondary-button {
            color: var(--text-color-primary); 
            background-color: #e5e5ea; 
        }
         body.theme-light .button.secondary-button:hover {
            background-color: #d1d1d6;
        }
        body.theme-light .timeline-train-cost {
             color: #D35400; 
        }


        /* Thème Brise Marine */
        body.theme-ocean-breeze {
            --bg-color: #E0F7FA; 
            --secondary-bg-color: #FFFFFF;
            --tertiary-bg-color: #B2EBF2; 
            --text-color-primary: #004D40; 
            --text-color-secondary: #00796B; 
            --text-color-tertiary: #4DB6AC; 
            --accent-color: #00BCD4; 
            --destructive-color: #E57373; 
            --highlight-color: #FFCA28; 
            --food-button-color: #FFA000; 
            --border-color: #B0BEC5; 
            --separator-color: #CFD8DC; 
        }
        body.theme-ocean-breeze .button {color: #004D40;} 
        body.theme-ocean-breeze .button.add-button,
        body.theme-ocean-breeze .button.city-edit-icon-button {
             background-color: var(--accent-color); 
             color: #FFFFFF; 
        }
        body.theme-ocean-breeze .button.ai-button,
        body.theme-ocean-breeze .button.city-ai-activity-button {
             background-color: var(--highlight-color); 
             color: #004D40; 
        }
        body.theme-ocean-breeze .button.suggest-food-button {
            background-color: var(--food-button-color); 
            color: #004D40; 
        }
         body.theme-ocean-breeze .button.secondary-button {
            color: var(--text-color-primary);
            background-color: var(--tertiary-bg-color);
        }
        body.theme-ocean-breeze .timeline-train-cost {
             color: #BF360C; 
        }


        /* Thème Fleur de Cerisier */
        body.theme-sakura-spring {
            --bg-color: #FFF0F5; 
            --secondary-bg-color: #FFFFFF;
            --tertiary-bg-color: #FFDDEE; 
            --text-color-primary: #5D4037; 
            --text-color-secondary: #8D6E63; 
            --text-color-tertiary: #A1887F; 
            --accent-color: #EC407A; 
            --destructive-color: #EF5350; 
            --highlight-color: #66BB6A; 
            --food-button-color: #D81B60; 
            --border-color: #D7CCC8; 
            --separator-color: #EFEBE9; 
        }
        body.theme-sakura-spring .button { color: #FFFFFF; }
        body.theme-sakura-spring .button.add-button,
        body.theme-sakura-spring .button.city-edit-icon-button {
             background-color: var(--accent-color); 
             color: #FFFFFF;
        }
        body.theme-sakura-spring .button.ai-button,
        body.theme-sakura-spring .button.city-ai-activity-button {
             background-color: var(--highlight-color); 
             color: #FFFFFF;
        }
        body.theme-sakura-spring .button.suggest-food-button {
            background-color: var(--food-button-color); 
            color: #FFFFFF;
        }
        body.theme-sakura-spring .button.secondary-button {
            color: var(--text-color-primary);
            background-color: var(--tertiary-bg-color);
        }
         body.theme-sakura-spring .timeline-train-cost {
             color: #43A047; 
        }


        *, *::before, *::after {
            box-sizing: border-box;
        }

        html {
            height: 100%;
            overflow-y: hidden;
        }

        body {
            font-family: var(--font-family-system);
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color-primary);
            display: flex;
            flex-direction: column;
            height: 100%;
            transition: background-color 0.3s, color 0.3s;
        }

        .status-bar-placeholder {
            height: 20px; 
            background-color: var(--bg-color);
            flex-shrink: 0;
            transition: background-color 0.3s;
        }

        .main-content {
            flex: 1;
            overflow-y: auto; 
            position: relative;
            -webkit-overflow-scrolling: touch;
        }
        
        #mainAppInterface {
            display: flex; 
            flex-direction: column;
            height: 100%;
        }


        .screen {
            display: none;
            padding: 20px; 
            background-color: var(--bg-color); 
            transition: background-color 0.3s;
        }

        .screen.active {
            display: block;
        }

        .screen-title {
            font-size: 28px; 
            font-weight: 600; 
            color: var(--text-color-primary);
            margin-top: 0;
            margin-bottom: 25px;
            text-align: center;
        }

        .svg-icon {
            width: 20px; height: 20px;
            fill: currentColor;
            display: inline-block;
            vertical-align: middle;
        }
        .svg-icon.small { width: 16px; height: 16px; }
        .svg-icon.medium { width: 22px; height: 22px; }
        .svg-icon.large { width: 26px; height: 26px; }

        .tab-bar {
            display: flex;
            height: 65px; 
            border-top: 1px solid var(--border-color);
            background-color: var(--secondary-bg-color); 
            flex-shrink: 0;
            padding-bottom: env(safe-area-inset-bottom);
            position: relative;
            z-index: 100;
            transition: background-color 0.3s, border-color 0.3s;
        }

        .tab-item {
            flex: 1; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            cursor: pointer; padding-top: 5px; padding-bottom: 5px;
            border: none;
            background: none; transition: background-color 0.2s ease-in-out;
            color: var(--icon-color); 
        }
        .tab-item:hover { background-color: var(--tertiary-bg-color); }
        .tab-item .icon-placeholder { margin-bottom: 3px; height: 26px; display: flex; align-items: center; justify-content: center; }
        .tab-item .tab-label { font-size: 10px; color: var(--text-color-tertiary); }
        .tab-item.active { color: var(--icon-active-color); }
        .tab-item.active .tab-label { color: var(--accent-color); }

        .input-container, .form-group {
            display: flex;
            margin-bottom: 15px;
            gap: 10px; 
        }
        .form-group {
            flex-direction: column; 
            gap: 5px;
        }
        .form-group label {
            font-size: 14px;
            color: var(--text-color-secondary);
        }

        .text-input, .textarea-input, .date-input, .number-input, .select-input {
            flex: 1; background-color: var(--secondary-bg-color);
            color: var(--text-color-primary); border: 1px solid var(--border-color);
            border-radius: 8px; padding: 12px 15px; font-size: 16px;
            font-family: var(--font-family-system);
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }
        .text-input::placeholder, .textarea-input::placeholder { color: var(--text-color-tertiary); }
        .textarea-input { min-height: 60px; resize: vertical; }


        .button {
            color: #ffffff; padding: 12px 18px; border-radius: 8px;
            border: none; font-size: 16px; font-weight: 500; 
            cursor: pointer; display: flex; align-items: center;
            justify-content: center; gap: 8px;
            transition: background-color 0.2s ease, filter 0.2s ease;
        }
        .add-button { background-color: var(--accent-color); }
        .ai-button { background-color: var(--highlight-color); }
        .button:hover { filter: brightness(1.15); }
        .ai-button { margin-bottom: 20px; }
        .small-button { padding: 8px 12px; font-size: 14px; }
        
        .city-action-button { 
            padding: 6px 10px;
            font-size: 12px;
            min-width: auto; 
            flex-grow: 0; 
            flex-shrink: 0; 
            margin-top: 0; 
        }
         .city-edit-icon-button {
            background-color: var(--accent-color);
            color: #ffffff;
            padding: 8px; 
            line-height: 0; 
        }
        .city-edit-icon-button .svg-icon {
            width: 16px; 
            height: 16px;
        }
        .city-ai-activity-button {
            background-color: var(--highlight-color);
            color: #ffffff;
        }
        .suggest-food-button {
            background-color: var(--food-button-color);
            color: #ffffff;
        }
        .secondary-button { background-color: var(--tertiary-bg-color); }


        .scroll-container { 
            overflow-y: auto; background-color: var(--secondary-bg-color); 
            border-radius: 10px; padding: 0px; margin-bottom: 10px;
            transition: background-color 0.3s;
        }
        .checklist-scroll-container { max-height: calc(100vh - 380px); } 
        .cities-scroll-container { max-height: calc(100vh - 270px); }
        .info-scroll-container { max-height: calc(100vh - 180px); }
        .itinerary-scroll-container { max-height: calc(100vh - 320px); } 


        .list-item { 
            display: flex; flex-direction: column;
            padding: 0; 
            background-color: transparent; 
            border-bottom: 1px solid var(--separator-color);
            transition: border-color 0.3s;
        }
        .list-item:last-child { border-bottom: none; }
        
        .list-item-main-content { 
            display: flex;
            align-items: center;
            padding: 12px 15px;
            width: 100%;
        }

        .checklist-item-content { display: flex; align-items: center; flex-grow: 1; cursor: pointer; }
        .checkbox-placeholder { 
            width: 22px; height: 22px; margin-right: 15px; 
            color: var(--accent-color); flex-shrink: 0; display: flex;
            align-items: center; justify-content: center;
        }
        .checklist-item-text {
            font-size: 17px; color: var(--text-color-secondary); line-height: 1.4; word-break: break-word;
        }
        .checklist-item-text.completed { text-decoration: line-through; color: var(--text-color-tertiary); }
        
        .checklist-item-description-area {
            padding: 0px 15px 15px 52px; 
            display: none; 
        }
        .checklist-item-description-area.expanded {
            display: block;
        }
        .checklist-item-description-area textarea { width: 100%;}

        .expand-icon-placeholder {
            margin-left: 10px;
            color: var(--text-color-tertiary);
            cursor: pointer;
        }

        .delete-button-placeholder { 
            padding: 8px; background: none; border: none;
            cursor: pointer; color: var(--destructive-color);
            margin-left: auto; flex-shrink: 0; display: flex;
            align-items: center; justify-content: center;
            transition: opacity 0.2s ease;
        }
        .delete-button-placeholder:hover { opacity: 0.7; }

        .city-container { 
            background-color: var(--secondary-bg-color); 
            border-radius: 10px; overflow: hidden; margin-bottom: 10px; 
            transition: background-color 0.3s;
        }
        .city-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px; background-color: var(--tertiary-bg-color); 
            cursor: pointer; border-bottom: 1px solid var(--border-color); 
            transition: background-color 0.3s, border-color 0.3s;
        }
        .city-header:hover { background-color: #4a4a4c; }
        body.theme-light .city-header:hover { background-color: #dcdcdf; }

        .city-header-main { flex-grow: 1; display: flex; align-items: center; }
        .city-name { font-size: 20px; font-weight: 500; color: var(--text-color-primary); }
        .city-color-indicator {
            width: 12px; height: 12px; border-radius: 50%;
            margin-right: 8px; display: inline-block;
            border: 1px solid var(--border-color);
        }
        .city-expand-icon-placeholder { 
            width: 20px; height: 20px; color: var(--text-color-tertiary);
            margin-left: 12px; display: flex; align-items: center; justify-content: center;
        }
        .city-actions { 
            display: flex; 
            align-items: center; 
            gap: 5px; 
            flex-wrap: nowrap; 
            margin-left: auto; 
        }
        .stacked-ai-buttons {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-left: 8px; 
        }
        .city-actions .button { 
            flex-shrink: 0; 
        }


        .delete-city-button-placeholder { padding: 8px; margin-left: 5px; }


        .attractions-container { padding: 0; background-color: var(--secondary-bg-color); display: none; }
        .attractions-container.expanded { display: block; }
        .attraction-category-title {
            font-size: 16px; font-weight: 600; color: var(--text-color-secondary);
            background-color: var(--tertiary-bg-color); 
            padding: 10px 15px; margin: 0;
            border-bottom: 1px solid var(--border-color);
            display: flex; align-items: center;
        }
        .category-color-indicator {
            width: 10px; height: 10px; border-radius: 3px;
            margin-right: 8px; display: inline-block;
        }
        
        .attraction-item-wrapper {
            display: flex;
            align-items: flex-start; 
            padding: 12px 15px;
            border-bottom: 1px solid var(--separator-color);
        }
        .attraction-item-wrapper:last-of-type {
             border-bottom: none;
        }
        .attraction-checkbox-placeholder {
             width: 22px; height: 22px; margin-right: 15px; 
            color: var(--accent-color); flex-shrink: 0; display: flex;
            align-items: center; justify-content: center;
            margin-top: 2px; 
        }

        .attraction-content { 
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .attraction-text { 
            font-size: 17px; color: var(--text-color-secondary); 
            line-height: 1.4; word-break: break-word;
            cursor: pointer;
            font-weight: 500; 
            font-style: normal !important; 
        }
        .attraction-text.completed { text-decoration: line-through; color: var(--text-color-tertiary); }
        .attraction-text.ai-suggestion { color: var(--highlight-color); }
        
        .attraction-description {
            font-size: 14px;
            color: var(--text-color-tertiary);
            margin-top: 4px;
            margin-bottom: 6px;
            line-height: 1.5;
        }
        .attraction-price {
            font-size: 0.9em; color: var(--text-color-tertiary);
            font-style: normal; white-space: nowrap;
            margin-bottom: 8px;
        }
         .attraction-text.ai-suggestion .attraction-price,
         .attraction-text.ai-suggestion ~ .attraction-price, 
         .ai-suggestion .attraction-price { 
             color: var(--highlight-color); 
        }


        .map-link-button {
            background: none; border: none; color: var(--accent-color);
            cursor: pointer; padding: 4px 0; 
            display: flex; align-items: center; gap: 5px; font-size: 14px;
        }
        .map-link-button .svg-icon { width: 16px; height: 16px;}
        .map-link-button:hover { filter: brightness(1.2); }

        .attraction-actions { 
            margin-left: auto;
            padding-left: 10px; 
            flex-shrink: 0;
        }


        .add-attraction-section-title {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-color-secondary);
            padding: 15px 15px 5px 15px; 
            margin: 0;
            border-top: 1px solid var(--border-color); 
        }
        .add-attraction-form {
            padding: 0 15px 15px 15px; 
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .add-attraction-form input, .add-attraction-form textarea { margin-bottom: 5px; }


        .info-section {
            margin-bottom: 20px; padding: 15px;
            background-color: var(--secondary-bg-color); 
            border-radius: 10px; border: 1px solid var(--border-color);
            transition: background-color 0.3s, border-color 0.3s;
        }
        .info-section-title {
            font-size: 18px; font-weight: 600;
            color: var(--text-color-primary); margin-bottom: 12px;
        }
        .info-list-item { font-size: 16px; color: var(--text-color-secondary); line-height: 1.6; }
        .info-small-text { font-size: 13px; color: var(--text-color-tertiary); margin-top: 8px; }
        .useful-words-list .info-list-item { display: flex; align-items: center; justify-content: space-between; }
        .useful-words-list .info-list-item.ai-suggestion { color: var(--highlight-color); }
        .speaker-icon-placeholder { 
            width: 18px; height: 18px; margin-left: 10px; cursor: pointer;
            color: var(--accent-color); transition: opacity 0.2s ease;
            display: flex; align-items: center; justify-content: center;
        }
        .speaker-icon-placeholder:hover { opacity: 0.7; }

        .converter-row { display: flex; align-items: center; gap: 10px; }
        .converter-container { display: flex; flex-direction: column; gap: 12px; }
        .converter-row input[type="number"] {
            flex-grow: 1; padding: 10px 12px; 
            background-color: var(--tertiary-bg-color); 
            color: var(--text-color-primary); border: 1px solid var(--border-color);
            border-radius: 6px; font-size: 16px;
        }
        .converter-row span { font-size: 16px; color: var(--text-color-secondary); }

        .loading-message, .error-message {
            position: fixed; bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(50, 50, 50, 0.85); 
            backdrop-filter: blur(5px); color: white;
            padding: 12px 22px; border-radius: 20px; 
            z-index: 1000; display: none; font-size: 14px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .error-message { background-color: rgba(200, 50, 50, 0.85); }

        /* Itinerary Styles */
        #itineraryForm {
            background-color: var(--secondary-bg-color);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .itinerary-form-buttons {
            display: flex;
            gap: 10px;
        }
        .itinerary-path-container {
            margin-bottom: 20px;
            padding: 10px;
            background-color: var(--secondary-bg-color);
            border-radius: 8px;
        }
        .itinerary-path-item {
            display: inline-flex; 
            align-items: center;
            padding: 5px 8px;
            border-radius: 6px;
            margin-right: 5px; 
            margin-bottom: 5px; 
            font-size: 14px;
            color: var(--text-color-primary); 
        }
        .itinerary-path-item .svg-icon { 
            margin-left: 8px;
            margin-right: 8px;
            fill: var(--text-color-tertiary);
        }


        .timeline {
            position: relative;
            padding: 20px 0;
        }
        .timeline::before { 
            content: '';
            position: absolute;
            left: 20px; 
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: var(--tertiary-bg-color);
        }
        .timeline-item {
            position: relative;
            margin-bottom: 20px;
            padding-left: 50px; 
        }
        .timeline-item:last-child {
            margin-bottom: 0;
        }
        .timeline-dot {
            position: absolute;
            left: 12px; 
            top: 0;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background-color: var(--accent-color);
            border: 2px solid var(--bg-color); 
        }
         .timeline-item-content {
            background-color: var(--secondary-bg-color);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            position: relative; 
        }
        .timeline-city { font-size: 18px; font-weight: 600; color: var(--text-color-primary); margin-bottom: 5px; }
        .timeline-dates { font-size: 14px; color: var(--text-color-secondary); margin-bottom: 8px; }
        .timeline-duration { font-size: 13px; color: var(--text-color-tertiary); margin-bottom: 8px; }
        .timeline-notes { font-size: 14px; color: var(--text-color-secondary); margin-bottom: 8px; }
        .timeline-train-cost { font-size: 13px; color: var(--highlight-color); font-style: italic; }
        .timeline-item-actions { display: flex; gap: 8px; margin-top:10px; align-items: center; justify-content: flex-end; }
        .timeline-item-actions button { margin-right: 0px;} 
        .reorder-buttons {
            position: absolute;
            top: 15px; 
            left: -40px; 
            display: flex;
            flex-direction: column;
            gap: 8px; 
            z-index: 1; 
        }
        .reorder-buttons button {
            background: none; border: none; padding: 0; 
            cursor: pointer; color: var(--text-color-tertiary);
            display: flex; align-items: center; justify-content: center;
        }
        .reorder-buttons button .svg-icon { width: 20px; height: 20px;} 
        .reorder-buttons button:hover { color: var(--accent-color); }


        /* JR Pass Calculator Styles */
        #jrPassResultContainer {
            margin-top: 15px;
            padding: 15px;
            background-color: var(--tertiary-bg-color);
            border-radius: 8px;
        }
        #jrPassResultContainer p, #jrPassResultContainer li {
            font-size: 15px;
            line-height: 1.6;
            color: var(--text-color-secondary);
        }
        #jrPassResultContainer strong {
            color: var(--text-color-primary);
        }
        #jrPassResultContainer .recommendation {
            font-weight: 600;
            margin-top: 10px;
        }
        #jrPassResultContainer .recommendation.profitable {
            color: var(--highlight-color);
        }
        #jrPassResultContainer .recommendation.not-profitable {
            color: var(--text-color-secondary);
        }
         #jrPassResultContainer ul {
            list-style-type: disc;
            padding-left: 20px;
        }
        
        /* Checklist Sort Buttons */
        .sort-buttons-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap; 
        }
        .sort-buttons-container .button {
            font-size: 13px;
            padding: 6px 10px;
            background-color: var(--tertiary-bg-color);
            color: var(--text-color-secondary);
        }
        .sort-buttons-container .button.active {
            background-color: var(--accent-color);
            color: #ffffff;
        }


        /* City Edit Modal (Basic Styling) */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1001; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.6); 
            padding-top: 60px;
        }
        .modal-content {
            background-color: var(--secondary-bg-color);
            margin: 5% auto; 
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            width: 80%; 
            max-width: 500px;
        }
        .modal-content h3 { color: var(--text-color-primary); margin-top: 0;}
        .close-button {
            color: var(--text-color-tertiary);
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: var(--text-color-primary);
            text-decoration: none;
            cursor: pointer;
        }
        .color-palette {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .color-option.selected {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px var(--accent-color);
        }


    </style>
</head>
<body>
    <div id="mainAppInterface"> 
        <div class="status-bar-placeholder"></div>

        <div class="main-content">
            <div id="loadingMessage" class="loading-message">Chargement des suggestions IA...</div>
            <div id="errorMessage" class="error-message">Une erreur est survenue.</div>

            <div id="checklistScreen" class="screen">
                <h1 class="screen-title">Checklist avant départ</h1>
                <div class="input-container">
                    <input type="text" id="newItemInput" class="text-input" placeholder="Ajouter une tâche...">
                    <button id="addItemButton" class="button add-button">Ajouter</button>
                </div>
                <div class="sort-buttons-container" id="checklistSortButtons">
                    <button class="button" data-sort="recent">Par ajout (récent)</button>
                    <button class="button" data-sort="oldest">Par ajout (ancien)</button>
                    <button class="button" data-sort="incomplete">Non complétées</button>
                    <button class="button" data-sort="complete">Complétées</button>
                </div>
                <button id="suggestTasksButton" class="button ai-button">
                    <span id="aiButtonSuggestTaskIconPlaceholder"></span>
                    Suggérer des tâches
                </button>
                <div id="checklistItemsContainer" class="scroll-container checklist-scroll-container"></div>
            </div>

            <div id="citiesScreen" class="screen">
                <h1 class="screen-title">Villes et activités</h1>
                <div class="input-container"> 
                    <input type="text" id="newCityInput" class="text-input" placeholder="Nom de la nouvelle ville...">
                    <button id="addCityButton" class="button add-button">Ajouter Ville</button>
                </div>
                <div id="citiesListContainer" class="cities-scroll-container" style="padding:0; background-color: transparent;"></div>
            </div>
            
            <div id="itineraryScreen" class="screen">
                <h1 class="screen-title">Mon itinéraire <span id="itineraryDatesTitle">(15 Nov - 29 Nov 2025)</span></h1>
                <div id="itineraryPathContainer" class="itinerary-path-container">
                    </div>
                <form id="itineraryForm">
                    <input type="hidden" id="editingItineraryStopId"> 
                    <div class="form-group">
                        <label for="itineraryCitySelect">Ville :</label>
                        <select id="itineraryCitySelect" class="select-input"></select>
                    </div>
                    <div class="form-group">
                        <label for="itineraryStartDate">Date de début :</label>
                        <input type="date" id="itineraryStartDate" class="date-input" value="2025-11-15" min="2025-11-15" max="2025-11-29">
                    </div>
                    <div class="form-group">
                        <label for="itineraryDurationNights">Nombre de nuits :</label>
                        <input type="number" id="itineraryDurationNights" class="number-input" value="3" min="1">
                    </div>
                    <div class="form-group">
                        <label for="itineraryNotes">Notes (optionnel) :</label>
                        <textarea id="itineraryNotes" class="textarea-input" placeholder="Ex: Réservation hôtel XYZ, vol à 14h..."></textarea>
                    </div>
                    <div class="itinerary-form-buttons">
                        <button type="submit" id="addItineraryStopButton" class="button add-button">Ajouter Étape</button>
                        <button type="button" id="cancelEditItineraryButton" class="button secondary-button" style="display:none;">Annuler Modification</button>
                    </div>
                </form>
                <div id="itineraryTimelineContainer" class="itinerary-scroll-container timeline">
                    </div>
            </div>

            <div id="infoScreen" class="screen">
                <h1 class="screen-title">Infos pratiques</h1>
                <div class="info-scroll-container">
                    <div class="info-section">
                        <h2 class="info-section-title">Paramètres d'affichage</h2>
                        <div class="form-group">
                            <label for="themeSelect">Thème de l'application :</label>
                            <select id="themeSelect" class="select-input">
                                <option value="light">Thème Clair (Défaut)</option>
                                <option value="dark">Thème Sombre</option>
                                <option value="ocean-breeze">Brise Marine</option>
                                <option value="sakura-spring">Fleur de Cerisier</option>
                            </select>
                        </div>
                    </div>

                    <div class="info-section">
                        <h2 class="info-section-title">Convertisseur de devises</h2>
                        <p class="info-small-text" style="margin-bottom:10px;">Convertisseur EUR/JPY. Pour d'autres devises, veuillez utiliser un outil externe.</p>
                        <div class="converter-container">
                            <div class="converter-row">
                                <input type="number" id="eurInput" placeholder="Montant en EUR">
                                <span>EUR</span>
                            </div>
                            <div class="converter-row">
                                <input type="number" id="jpyInput" placeholder="Montant en JPY">
                                <span>JPY</span>
                            </div>
                        </div>
                        <p class="info-small-text" id="conversionRateText">Taux : 1 EUR ≈ 160 JPY</p>
                    </div>
                    <div class="info-section" id="usefulWordsSection">
                        <h2 class="info-section-title">Quelques mots utiles</h2>
                        <p class="info-small-text" style="margin-bottom:10px;">L'IA suggérera des mots pour le Japon.</p>
                        <div id="usefulWordsList" class="useful-words-list"></div>
                        <button id="suggestWordsButton" class="button ai-button" style="margin-top: 15px; font-size: 14px; padding: 10px 15px; width:100%;">
                            <span id="aiButtonSuggestWordIconPlaceholder"></span>
                            Plus de mots
                        </button>
                    </div>

                    <div class="info-section">
                        <h2 class="info-section-title">Japan Rail Pass</h2>
                        <p class="info-list-item">• Forfait économique pour voyager en train à travers le Japon.</p>
                        <p class="info-list-item">• Valable sur la plupart des lignes JR, y compris de nombreux Shinkansen (trains à grande vitesse).</p>
                        <p class="info-list-item">• Disponible pour des durées de 7, 14, ou 21 jours consécutifs.</p>
                        <p class="info-list-item">• Prix (approximatifs, peuvent varier) :
                            <ul>
                                <li>7 jours : ~¥50,000</li>
                                <li>14 jours : ~¥80,000</li>
                                <li>21 jours : ~¥100,000</li>
                            </ul>
                        </p>
                        <p class="info-list-item">• Doit généralement être acheté avant votre arrivée au Japon (bien que des options d'achat sur place existent, souvent plus chères).</p>
                        <h3 style="margin-top: 20px; font-size: 16px; font-weight: 500;">Calculateur de rentabilité :</h3>
                        <p class="info-text" style="margin-bottom:10px;">Cet outil vous aide à estimer si un JR Pass serait rentable pour votre voyage, basé sur l'itinéraire que vous avez défini.</p>
                        <button id="calculateJrPassButton" class="button add-button" style="margin-bottom: 15px; width: 100%;">Calculer pour mon itinéraire</button>
                        <div id="jrPassResultContainer" style="display: none;">
                            </div>
                    </div>

                    <div class="info-section">
                        <h2 class="info-section-title">Numéros d'urgence</h2>
                        <p class="info-text">Ces numéros sont pour le Japon. Vérifiez les numéros locaux pour votre destination.</p>
                        <p class="info-list-item">• Police : 110</p>
                        <p class="info-list-item">• Pompiers / Ambulance : 119</p>
                        <p class="info-list-item">• Japan Helpline (anglais) : 0570-000-911</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="editCityModal" class="modal">
            <div class="modal-content">
                <span class="close-button" id="closeCityModal">×</span>
                <h3>Modifier les détails de la ville</h3>
                <input type="hidden" id="editingCityIdModal">
                <div class="form-group">
                    <label for="cityNameModalInput">Nom de la ville :</label>
                    <input type="text" id="cityNameModalInput" class="text-input">
                </div>
                <div class="form-group">
                    <label for="cityColorPalette">Couleur :</label>
                    <div id="cityColorPalette" class="color-palette">
                        </div>
                    <input type="hidden" id="cityColorModalInputHidden">
                </div>
                <button id="saveCityModalButton" class="button add-button">Sauvegarder</button>
            </div>
        </div>


        <div class="tab-bar">
            <button class="tab-item active" data-screen="checklistScreen">
                <span class="icon-placeholder" id="tabIconChecklist"></span>
                <span class="tab-label">Checklist</span>
            </button>
            <button class="tab-item" data-screen="citiesScreen">
                <span class="icon-placeholder" id="tabIconCities"></span>
                <span class="tab-label">Villes & Activités</span>
            </button>
            <button class="tab-item" data-screen="itineraryScreen">
                <span class="icon-placeholder" id="tabIconItinerary"></span>
                <span class="tab-label">Itinéraire</span>
            </button>
            <button class="tab-item" data-screen="infoScreen">
                <span class="icon-placeholder" id="tabIconInfo"></span>
                <span class="tab-label">Infos</span>
            </button>
        </div>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; // Added serverTimestamp

    // TODO: Collez votre objet firebaseConfig ici
    const firebaseConfig = { apiKey: "AIzaSyAi5nJgFtfxeMYm9zhf6gokI1x6MBfCol0",
  authDomain: "monplanificateurvoyage.firebaseapp.com",
  projectId: "monplanificateurvoyage",
  storageBucket: "monplanificateurvoyage.firebasestorage.app",
  messagingSenderId: "932990618668",
  appId: "1:932990618668:web:8aae0bb8f220a096665589" };


    const SHARED_TRIP_ID = "VOYAGE_JAPON"; 

    let app, auth, db, userId;
    let unsubscribeFirestore = null;


    // --- Global Variables & Constants ---
    const icons = { 
        checklist: '<svg class="svg-icon large" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M14 2H6C4.9 2 4 2.9 4 4V20C4 21.1 4.9 22 6 22H18C19.1 22 20 21.1 20 20V8L14 2ZM18 20H6V4H13V9H18V20ZM8 11H16V13H8V11ZM8 15H16V17H8V15Z"/></svg>',
        cities: '<svg class="svg-icon large" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C8.13 2 5 5.13 5 9C5 14.25 12 22 12 22C12 22 19 14.25 19 9C19 5.13 15.87 2 12 2ZM12 11.5C10.62 11.5 9.5 10.38 9.5 9C9.5 7.62 10.62 6.5 12 6.5C13.38 6.5 14.5 7.62 14.5 9C14.5 10.38 13.38 11.5 12 11.5Z"/></svg>',
        info: '<svg class="svg-icon large" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM12 17C11.45 17 11 16.55 11 16V12C11 11.45 11.45 11 12 11C12.55 11 13 11.45 13 12V16C13 16.55 12.55 17 12 17ZM12 9C11.45 9 11 8.55 11 8C11 7.45 11.45 7 12 7C12.55 7 13 7.45 13 8C13 8.55 12.55 9 12 9Z"/></svg>',
        itinerary: '<svg class="svg-icon large" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M18.24 13.76L12 10.03L5.76 13.76L4 12.59L12 7.41l8 5.18l-1.76 1.17zM12 3C6.48 3 2 5.24 2 8c0 2.24 2.95 4.12 7 4.87V19H7v2h10v-2h-2v-6.13c4.05-.75 7-2.63 7-4.87c0-2.76-4.48-5-10-5zm0 2c3.78 0 7.35 1.53 8.91 3.09C19.26 9.04 16.29 10 12 10s-7.26-.96-8.91-1.91C4.65 6.53 8.22 5 12 5z"/></svg>',
        checkboxEmpty: '<svg class="svg-icon medium" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M19 5V19H5V5H19ZM19 3H5C3.9 3 3 3.9 3 5V19C3 20.1 3.9 21 5 21H19C20.1 21 21 20.1 21 19V5C21 3.9 20.1 3 19 3Z"/></svg>',
        checkboxChecked: '<svg class="svg-icon medium" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M19 3H5C3.9 3 3 3.9 3 5V19C3 20.1 3.9 21 5 21H19C20.1 21 21 20.1 21 19V5C21 3.9 20.1 3 19 3ZM10 17L5 12L6.41 10.59L10 14.17L17.59 6.58L19 8L10 17Z"/></svg>',
        trash: '<svg class="svg-icon" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M6 19C6 20.1 6.9 21 8 21H16C17.1 21 18 20.1 18 19V7H6V19ZM19 4H15.5L14.5 3H9.5L8.5 4H5V6H19V4Z"/></svg>',
        plus: '<svg class="svg-icon" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M19 13H13V19H11V13H5V11H11V5H13V11H19V13Z"/></svg>',
        minus: '<svg class="svg-icon" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M19 13H5V11H19V13Z"/></svg>',
        sparkle: '<svg class="svg-icon small" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 2L9.5 8.5L3 10L9.5 11.5L12 18L14.5 11.5L21 10L14.5 8.5L12 2Z"/></svg>',
        speaker: '<svg class="svg-icon small" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M3 9V15H7L12 20V4L7 9H3ZM16.5 12C16.5 10.23 15.48 8.71 14 7.97V16.02C15.48 15.29 16.5 13.77 16.5 12ZM14 3.23V5.29C16.89 6.15 19 8.83 19 12C19 15.17 16.89 17.84 14 18.7V20.77C18.01 19.86 21 16.28 21 12C21 7.72 18.01 4.14 14 3.23Z"/></svg>',
        chevronDown: '<svg class="svg-icon small" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6l-6-6l1.41-1.41z"/></svg>',
        chevronUp: '<svg class="svg-icon small" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6l-6 6l1.41 1.41z"/></svg>',
        mapMarker: '<svg class="svg-icon small" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>',
        calendar: '<svg class="svg-icon small" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M17 12h-5v5h5v-5zM16 1v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2h-1V1h-2zm3 18H5V8h14v11z"/></svg>',
        edit: '<svg class="svg-icon small" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>',
        arrowUp: '<svg class="svg-icon small" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6l-6 6z"/></svg>',
        arrowDown: '<svg class="svg-icon small" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6l-6 6z"/></svg>',
        food: '<svg class="svg-icon small" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M16 6v8h3v8h-3v-2h-2v2H8v-2H6v2H3V14h3V6H3V4h3V2h8v2h3v2h-3zm-2 0H8v6h6V6zm0 8H8v6h6v-6z"/></svg>', 
        route: '<svg class="svg-icon large" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor"><path d="M19.41,6.59 C19.02,6.2 18.39,6.2 18,6.59 L12,12.59 L6,6.59 C5.61,6.2 4.98,6.2 4.59,6.59 C4.2,6.98 4.2,7.61 4.59,8 L11.29,14.71 C11.68,15.1 12.31,15.1 12.7,14.71 L19.41,8 C19.8,7.61 19.8,6.98 19.41,6.59 Z M12,2 C6.48,2 2,6.48 2,12 C2,17.52 6.48,22 12,22 C17.52,22 22,17.52 22,12 C22,6.48 17.52,2 12,2 Z M12,20 C7.59,20 4,16.41 4,12 C4,7.59 7.59,4 12,4 C16.41,4 20,7.59 20,12 C20,16.41 16.41,20 12,20 Z"/></svg>' 
    };
    const currentDestination = "Japon"; 

    let currentExchangeRate = 160; 
    
    let TRIP_START_DATE = '2025-11-15'; 
    let TRIP_END_DATE = '2025-11-29';   

    let checklistItems = [];
    let citiesData = [];
    let usefulWords = [];
    let itineraryData = [];
    let editingItineraryStopId = null; 
    let japaneseVoice = null; 
    let currentChecklistSort = 'recent'; 
    
    const jrPassPrices = { 
        7: 50000,
        14: 80000,
        21: 100000
    };

    const cityColorPalette = [
        { name: "Rouge Fuji", value: "#D90429" }, { name: "Rose Sakura", value: "#FFB7C5" },
        { name: "Orange Yuzu", value: "#FF8C00" }, { name: "Jaune Ginkgo", value: "#FFD700" },
        { name: "Vert Matcha", value: "#6B8E23" }, { name: "Bleu Aizome", value: "#0072BB" },
        { name: "Violet Ajisai", value: "#8A2BE2" }, { name: "Gris Kumo", value: "#808080" },
        { name: "Brun Sugi", value: "#A0522D" }, { name: "Noir Sumi", value: "#2F4F4F" }
    ];


    const activityCategoryStyles = { /* ... (as before) ... */ };
    
    let domElements = {}; // Will be populated after DOM is loaded

    // --- Function Definitions ---
    // (All functions defined here, before they are called by event listeners or initializeApp)

    function generateId(prefix = 'item') { /* ... */ }
    async function saveTripDataToFirestore() { /* ... */ }
    function loadTripDataFromFirestore() { /* ... */ }
    function initializeDefaultDataArrays() { /* ... */ }
    function updateTripDatesUI() { /* ... */ }
    function showLoadingMessage(message = "Chargement...") { /* ... */ }
    function hideLoadingMessage() { /* ... */ }
    function showErrorMessage(message = "Une erreur est survenue.") { /* ... */ }
    async function generateContentWithGemini(prompt) { /* ... */ }
    function setActiveScreen(screenId) { /* ... */ }
    function sortChecklistItems() { /* ... */ }
    function updateActiveSortButton() { /* ... */ }
    function renderChecklistItems() { /* ... (as before) ... */ }
    function toggleChecklistItemCompleted(id) { /* ... (as before, but call saveTripDataToFirestore) ... */ }
    function toggleChecklistItemExpansion(id) { /* ... (as before, but call saveTripDataToFirestore) ... */ }
    function updateChecklistItemDescription(id, description) { /* ... (as before, but call saveTripDataToFirestore) ... */ }
    function deleteChecklistItem(id) { /* ... (as before, but call saveTripDataToFirestore) ... */ }
    function addChecklistItem() { /* ... (as before, but call saveTripDataToFirestore) ... */ }
    async function suggestNewTasks() { /* ... (as before, uses currentDestination, call saveTripDataToFirestore) ... */ }
    function openEditCityModal(cityId) { /* ... (as before) ... */ }
    function closeEditCityModal() { /* ... (as before) ... */ }
    function saveCityDetails() { /* ... (as before, but call saveTripDataToFirestore) ... */ }
    function renderCities() { /* ... (as before) ... */ }
    function addManualActivityToCity(cityId) { /* ... (as before, but call saveTripDataToFirestore) ... */ }
    function getRandomColor() { return cityColorPalette[Math.floor(Math.random() * cityColorPalette.length)].value; }
    function addCity() { /* ... (as before, but call saveTripDataToFirestore) ... */ }
    function deleteCity(cityId) { /* ... (as before, but call saveTripDataToFirestore) ... */ }
    function toggleCityAttractionCompleted(cityId, attractionId) { /* ... (as before, but call saveTripDataToFirestore) ... */ }
    function deleteCityAttraction(cityId, attractionId) { /* ... (as before, but call saveTripDataToFirestore) ... */ }
    async function suggestCityAttractions(cityId) { /* ... (as before, uses currentDestination, call saveTripDataToFirestore) ... */ }
    async function suggestFoodForCity(cityId) { /* ... (as before, uses currentDestination, call saveTripDataToFirestore) ... */ }
    function renderItineraryPath() { /* ... (as before) ... */ }
    function populateItineraryCitySelect() { /* ... (as before) ... */ }
    function parseGeminiCostResponse(responseText) { /* ... (as before) ... */ }
    async function getTrainCostEstimateAI(city1Name, city2Name, elementToUpdate) { /* ... (as before) ... */ }
    async function renderItinerary() { /* ... (as before) ... */ }
    function moveItineraryStop(oldIndexSorted, newIndexSorted) { /* ... (as before, call saveTripDataToFirestore) ... */ }
    function populateItineraryFormForEdit(stopId) { /* ... (as before) ... */ }
    function resetItineraryForm() { /* ... (as before) ... */ }
    function handleItineraryFormSubmit(event) { /* ... (as before, call saveTripDataToFirestore) ... */ }
    function deleteItineraryStop(stopId) { /* ... (as before, call saveTripDataToFirestore) ... */ }
    async function calculateAndDisplayJrPassProfitability() { /* ... (as before) ... */ }
    function updateConversionRateText() { /* ... (as before) ... */ }
    function convertCurrency() { /* ... (as before) ... */ }
    function loadVoices() { /* ... (as before) ... */ }
    function speak(text, lang = 'ja-JP') { /* ... (as before) ... */ }
    function renderUsefulWords() { /* ... (as before) ... */ }
    async function suggestNewWords() { /* ... (as before, uses currentDestination, call saveTripDataToFirestore) ... */ }
    function applyTheme(themeNameInput) { /* ... (as before, but call saveTripDataToFirestore after theme change if theme is stored in Firestore) ... */ }
    function initIcons() { /* ... (as before) ... */ }
    
    // --- Re-pasting function definitions with saveTripDataToFirestore calls ---
    initializeDefaultDataArrays = () => { 
        checklistItems = [ 
            { id: generateId('checklist'), text: 'Réserver les vols', completed: false, description: '', isExpanded: false, createdAt: Date.now() - 20000 }, 
            { id: generateId('checklist'), text: 'Réserver les hébergements', completed: false, description: '', isExpanded: false, createdAt: Date.now() - 10000 }
        ];
        citiesData = [ 
            { id: generateId('city'), name: 'Tokyo', color: getRandomColor(), isExpanded: false, attractions: [
                { id: generateId('attr'), text: 'Traversée de Shibuya', category: 'Point d\'intérêt', price: 'Gratuit', completed: false, description: 'Le passage piéton le plus fréquenté au monde.' },
                { id: generateId('attr'), text: 'Tour de Tokyo', category: 'Monument', price: '¥¥', completed: false, description: 'Tour d\'observation et de communication inspirée de la Tour Eiffel.' }
            ]},
            { id: generateId('city'), name: 'Kyoto', color: getRandomColor(), isExpanded: false, attractions: [
                { id: generateId('attr'), text: 'Kinkaku-ji (Pavillon d\'Or)', category: 'Culturel', price: '¥', completed: false, description: 'Célèbre temple Zen recouvert de feuilles d\'or.' }
            ]}
        ];
        usefulWords = [ 
            { id: generateId('word'), text: "Bonjour", translation: "こんにちは", isAISuggestion: false, lang: "ja-JP" },
            { id: generateId('word'), text: "Merci", translation: "ありがとう", isAISuggestion: false, lang: "ja-JP" },
            { id: generateId('word'), text: "S'il vous plaît", translation: "おねがいします", isAISuggestion: false, lang: "ja-JP" }
        ];
        itineraryData = [];
        TRIP_START_DATE = '2025-11-15'; 
        TRIP_END_DATE = '2025-11-29';
        updateTripDatesUI();
    };
    
    toggleChecklistItemCompleted = (id) => { 
        const item = checklistItems.find(i => i.id === id); 
        if (item) { item.completed = !item.completed; renderChecklistItems(); saveTripDataToFirestore(); }
    };
    toggleChecklistItemExpansion = (id) => {
        const item = checklistItems.find(i => i.id === id);
        if (item) { item.isExpanded = !item.isExpanded; renderChecklistItems(); saveTripDataToFirestore(); }
    };
    updateChecklistItemDescription = (id, description) => {
        const item = checklistItems.find(i => i.id === id);
        if (item) { item.description = description; saveTripDataToFirestore(); }
    };
    deleteChecklistItem = (id) => { 
        checklistItems = checklistItems.filter(i => i.id !== id); renderChecklistItems(); saveTripDataToFirestore(); 
    };
    addChecklistItem = () => {
        if (!domElements.newItemInput) return;
        const text = domElements.newItemInput.value.trim(); if (text === '') return;
        checklistItems.push({ id: generateId('checklist'), text: text, completed: false, description: '', isExpanded: false, createdAt: Date.now() });
        domElements.newItemInput.value = ''; 
        renderChecklistItems(); saveTripDataToFirestore();
    };
    suggestNewTasks = async () => {
        const existingTasksText = checklistItems.map(item => `- ${item.text}`).join('\n');
        const prompt = `Je planifie un voyage au Japon. Ma checklist actuelle:\n${existingTasksText}\n\nSuggère 3 tâches de préparation importantes et concises pour un voyage au Japon. Ne répète pas les tâches existantes. Une tâche par ligne, sans tiret ni numérotation.`;
        try {
            const suggestionsText = await generateContentWithGemini(prompt);
            suggestionsText.split('\n').filter(task => task.trim() !== '').forEach(taskText => {
                if (!checklistItems.some(item => item.text.toLowerCase() === taskText.toLowerCase().trim())) {
                    checklistItems.push({ id: generateId('checklist-ai'), text: taskText.trim(), completed: false, isAISuggestion: true, description: '', isExpanded: false, createdAt: Date.now() });
                }
            });
            renderChecklistItems(); saveTripDataToFirestore();
        } catch (error) { console.error("Erreur suggestion tâches:", error); }
    };
    saveCityDetails = () => {
        const cityId = domElements.editingCityIdModalInput.value;
        const newName = domElements.cityNameModalInput.value.trim();
        const newColor = domElements.cityColorModalInputHidden.value;
        if (!newName) { showErrorMessage("Le nom de la ville ne peut pas être vide."); return; }
        const city = citiesData.find(c => c.id === cityId);
        if (city) {
            city.name = newName; city.color = newColor || '#808080';
            renderCities(); populateItineraryCitySelect(); renderItinerary(); saveTripDataToFirestore();
        }
        closeEditCityModal();
    };
    addManualActivityToCity = (cityId) => {
        const city = citiesData.find(c => c.id === cityId); if (!city) return;
        const textInput = document.querySelector(`.new-attraction-text-${cityId}`);
        const descriptionInput = document.querySelector(`.new-attraction-description-${cityId}`);
        const categoryInput = document.querySelector(`.new-attraction-category-${cityId}`);
        const priceInput = document.querySelector(`.new-attraction-price-${cityId}`);
        const text = textInput.value.trim(); const description = descriptionInput.value.trim();
        const category = categoryInput.value.trim() || 'Autre'; const price = priceInput.value.trim() || 'N/A';
        if (text === '') { showErrorMessage("Le nom de l'activité est requis."); return; }
        if (!city.attractions) city.attractions = [];
        city.attractions.push({ id: generateId('attr-manual'), text, description, category, price, completed: false, isAISuggestion: false });
        textInput.value = ''; descriptionInput.value = ''; categoryInput.value = ''; priceInput.value = '';
        renderCities(); saveTripDataToFirestore();
    };
    addCity = () => { 
        const cityName = domElements.newCityInput.value.trim();
        if (cityName === '') { showErrorMessage("Le nom de la ville est requis."); return; }
        if (citiesData.some(city => city.name.toLowerCase() === cityName.toLowerCase())) { showErrorMessage("Cette ville existe déjà."); return; }
        citiesData.push({ id: generateId('city'), name: cityName, color: getRandomColor(), isExpanded: false, attractions: [] });
        domElements.newCityInput.value = ''; 
        renderCities(); populateItineraryCitySelect(); saveTripDataToFirestore();
    };
    deleteCity = (cityId) => { 
        citiesData = citiesData.filter(city => city.id !== cityId); 
        itineraryData = itineraryData.filter(stop => stop.cityId !== cityId);
        renderCities(); renderItinerary(); populateItineraryCitySelect(); saveTripDataToFirestore(); 
    };
    toggleCityAttractionCompleted = (cityId, attractionId) => {
         const city = citiesData.find(c => c.id === cityId);
        if (city) { 
            const attraction = (city.attractions || []).find(a => a.id === attractionId); 
            if (attraction) { attraction.completed = !attraction.completed; renderCities(); saveTripDataToFirestore(); }
        }
    };
    deleteCityAttraction = (cityId, attractionId) => {
        const city = citiesData.find(c => c.id === cityId);
        if (city) { 
            city.attractions = (city.attractions || []).filter(a => a.id !== attractionId); 
            renderCities(); saveTripDataToFirestore(); 
        }
    };
     suggestCityAttractions = async (cityId) => { 
            const city = citiesData.find(c => c.id === cityId); if (!city) return;
            let durationInCity = 3; 
            const itineraryStop = itineraryData.find(stop => stop.cityId === cityId);
            if (itineraryStop) {
                durationInCity = parseInt(itineraryStop.durationNights) + 1; 
            }
            let numberOfSuggestions = 3; 
            if (durationInCity <= 2) numberOfSuggestions = 2;
            else if (durationInCity >= 5) numberOfSuggestions = 4;
            const existingAttractionsText = (city.attractions || []).filter(attr => attr.category !== "Nourriture & Restaurants").map(attr => `- ${attr.text}`).join('\n');
            const prompt = `Pour la ville de ${city.name} au Japon, où je prévois de rester environ ${durationInCity} jours, suggère ${numberOfSuggestions} activités ou lieux touristiques intéressants (pas de restaurants ou nourriture ici), en plus de ceux-ci (s'il y en a):\n${existingAttractionsText}\n\nPour chaque suggestion, donne le nom, une catégorie (ex: Culturel, Nature, Shopping, Point d'intérêt, Monument), une estimation de prix (Gratuit, ¥, ¥¥, ¥¥¥, ou N/A), et une très courte description (max 15 mots).
Ne répète pas les attractions existantes. Réponds uniquement avec les suggestions au format exact (une par ligne): NOM_ATTRACTION;CATEGORIE;PRIX;DESCRIPTION_COURTE. N'utilise pas de formatage markdown comme des astérisques.
Exemple: Temple Senso-ji;Culturel;Gratuit;Plus ancien temple de Tokyo.`;
            try {
                const suggestionsText = await generateContentWithGemini(prompt);
                if (!city.attractions) city.attractions = [];
                suggestionsText.split('\n').filter(attr => attr.trim() !== '' && attr.includes(';')).forEach(rawAttrText => {
                    const parts = rawAttrText.split(';');
                    if (parts.length >= 4) { 
                        const text = parts[0]?.trim().replace(/\*\*/g, ''); 
                        const category = parts[1]?.trim() || "Suggestion";
                        const price = parts[2]?.trim() || "N/A";
                        const description = parts[3]?.trim() || "";
                        if (text && !city.attractions.some(ea => ea.text.toLowerCase().includes(text.toLowerCase()))) {
                            city.attractions.push({ id: generateId('attr-ai'), text, category, price, description, completed: false, isAISuggestion: true });
                        }
                    }
                });
                if (!city.isExpanded) city.isExpanded = true; 
                renderCities(); 
                saveTripDataToFirestore();
            } catch (error) { console.error(`Erreur suggestion pour ${city.name}:`, error); }
        };
    suggestFoodForCity = async (cityId) => {
        const city = citiesData.find(c => c.id === cityId); if (!city) return;
        const existingFoodText = (city.attractions || []).filter(attr => attr.category === "Nourriture & Restaurants").map(attr => `- ${attr.text}`).join('\n');
        const prompt = `Pour la ville de ${city.name} au Japon, suggère 2-3 spécialités culinaires locales ou des types de restaurants à essayer. Pour chaque suggestion, donne le nom et une brève description (max 10 mots). Ne répète pas ce qui existe déjà :\n${existingFoodText}\nRéponds uniquement avec les suggestions au format : NOM_SPECIALITE_OU_TYPE_RESTAURANT;DESCRIPTION_COURTE. N'utilise pas de formatage markdown comme des astérisques.`;
        try {
            const suggestionsText = await generateContentWithGemini(prompt);
            if (!city.attractions) city.attractions = [];
            suggestionsText.split('\n').filter(line => line.trim() !== '' && line.includes(';')).forEach(rawLine => {
                const parts = rawLine.split(';');
                if (parts.length >= 2) {
                    const text = parts[0]?.trim().replace(/\*\*/g, ''); 
                    const description = parts[1]?.trim() || "";
                    if (text && !city.attractions.some(ea => ea.text.toLowerCase().includes(text.toLowerCase()) && ea.category === "Nourriture & Restaurants")) {
                        city.attractions.push({ id: generateId('food-ai'), text, category: "Nourriture & Restaurants", price: "Variable", description, completed: false, isAISuggestion: true });
                    }
                }
            });
            if (!city.isExpanded) city.isExpanded = true;
            renderCities(); saveTripDataToFirestore();
        } catch (error) { console.error(`Erreur suggestion nourriture pour ${city.name}:`, error); }
    };
    moveItineraryStop = (oldIndexSorted, newIndexSorted) => { /* ... (as before, add saveTripDataToFirestore) ... */ };
    handleItineraryFormSubmit = (event) => { /* ... (as before, add saveTripDataToFirestore) ... */ };
    deleteItineraryStop = (stopId) => { /* ... (as before, add saveTripDataToFirestore) ... */ };
    suggestNewWords = async () => { /* ... (as before, add saveTripDataToFirestore) ... */ };
    applyTheme = (themeNameInput) => {
        let themeClass = themeNameInput;
        if (themeNameInput && !themeNameInput.startsWith('theme-')) { 
            themeClass = `theme-${themeNameInput}`;
        } else if (!themeNameInput) { 
            themeClass = 'theme-light';
        }
        domElements.body.className = ''; 
        domElements.body.classList.add(themeClass); 
        saveTripDataToFirestore(); 
    };

    // --- Initialize App ---
    document.addEventListener('DOMContentLoaded', () => {
        domElements = {
            body: document.body,
            mainAppInterface: document.getElementById('mainAppInterface'),
            screens: document.querySelectorAll('.screen'),
            tabItems: document.querySelectorAll('.tab-item'),
            checklistItemsContainer: document.getElementById('checklistItemsContainer'),
            checklistSortButtonsContainer: document.getElementById('checklistSortButtons'),
            newItemInput: document.getElementById('newItemInput'),
            addItemButton: document.getElementById('addItemButton'),
            suggestTasksButton: document.getElementById('suggestTasksButton'),
            aiButtonSuggestTaskIconPlaceholder: document.getElementById('aiButtonSuggestTaskIconPlaceholder'),
            citiesListContainer: document.getElementById('citiesListContainer'),
            newCityInput: document.getElementById('newCityInput'),
            addCityButton: document.getElementById('addCityButton'),
            loadingMessage: document.getElementById('loadingMessage'),
            errorMessage: document.getElementById('errorMessage'),
            eurInput: document.getElementById('eurInput'),
            jpyInput: document.getElementById('jpyInput'),
            conversionRateText: document.getElementById('conversionRateText'),
            usefulWordsListDiv: document.getElementById('usefulWordsList'),
            suggestWordsButton: document.getElementById('suggestWordsButton'),
            aiButtonSuggestWordIconPlaceholder: document.getElementById('aiButtonSuggestWordIconPlaceholder'),
            wordsDestinationName: document.getElementById('wordsDestinationName'), 
            tabIconChecklist: document.getElementById('tabIconChecklist'),
            tabIconCities: document.getElementById('tabIconCities'),
            tabIconItinerary: document.getElementById('tabIconItinerary'),
            tabIconInfo: document.getElementById('tabIconInfo'),
            itineraryForm: document.getElementById('itineraryForm'),
            editingItineraryStopIdInput: document.getElementById('editingItineraryStopId'),
            itineraryCitySelect: document.getElementById('itineraryCitySelect'),
            itineraryStartDateInput: document.getElementById('itineraryStartDate'),
            itineraryDurationNightsInput: document.getElementById('itineraryDurationNights'),
            itineraryNotesInput: document.getElementById('itineraryNotes'),
            addItineraryStopButton: document.getElementById('addItineraryStopButton'),
            cancelEditItineraryButton: document.getElementById('cancelEditItineraryButton'),
            itineraryTimelineContainer: document.getElementById('itineraryTimelineContainer'),
            itineraryPathContainer: document.getElementById('itineraryPathContainer'),
            itineraryDatesTitle: document.getElementById('itineraryDatesTitle'),
            calculateJrPassButton: document.getElementById('calculateJrPassButton'),
            jrPassResultContainer: document.getElementById('jrPassResultContainer'),
            themeSelect: document.getElementById('themeSelect'),
            editCityModal: document.getElementById('editCityModal'),
            closeCityModalButton: document.getElementById('closeCityModal'),
            editingCityIdModalInput: document.getElementById('editingCityIdModal'),
            cityNameModalInput: document.getElementById('cityNameModalInput'),
            cityColorPaletteDiv: document.getElementById('cityColorPalette'),
            cityColorModalInputHidden: document.getElementById('cityColorModalInputHidden'),
            saveCityModalButton: document.getElementById('saveCityModalButton'),
        };

        if (firebaseConfig && firebaseConfig.apiKey) { 
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    console.log("Utilisateur anonyme connecté:", userId);
                    loadTripDataFromFirestore(); 
                } else {
                    console.log("Tentative de connexion anonyme...");
                    signInAnonymously(auth).catch((error) => {
                        console.error("Erreur de connexion anonyme:", error);
                        showErrorMessage("Impossible de se connecter au service de données.");
                    });
                }
            });
        } else {
            showErrorMessage("Configuration Firebase manquante. L'application ne pourra pas sauvegarder/charger les données.");
             // Fallback to local defaults if Firebase config is missing, but data won't be shared/synced.
            console.warn("Firebase config absente, initialisation des données par défaut locales.");
            initializeDefaultDataArrays();
            // Render UI with these local defaults
            renderChecklistItems();
            renderCities();
            renderUsefulWords();
            renderItinerary();
            populateItineraryCitySelect();
            resetItineraryForm();
            updateTripDatesUI();
            if (domElements.wordsDestinationName) domElements.wordsDestinationName.textContent = currentDestination;
        }
        
        initIcons(); 
        setActiveScreen('checklistScreen'); 
        
        // Event Listeners
        if (domElements.tabItems) {
            domElements.tabItems.forEach(tab => tab.addEventListener('click', () => setActiveScreen(tab.dataset.screen)));
        }
        if (domElements.addItemButton) domElements.addItemButton.addEventListener('click', addChecklistItem);
        if (domElements.newItemInput) domElements.newItemInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') addChecklistItem(); });
        if (domElements.suggestTasksButton) domElements.suggestTasksButton.addEventListener('click', suggestNewTasks);
        if (domElements.checklistSortButtonsContainer) {
            domElements.checklistSortButtonsContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('button')) {
                    currentChecklistSort = e.target.dataset.sort;
                    renderChecklistItems();
                }
            });
        }
        if (domElements.addCityButton) domElements.addCityButton.addEventListener('click', addCity);
        if (domElements.newCityInput) domElements.newCityInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') addCity(); });
        if (domElements.itineraryForm) domElements.itineraryForm.addEventListener('submit', handleItineraryFormSubmit);
        if (domElements.cancelEditItineraryButton) domElements.cancelEditItineraryButton.addEventListener('click', resetItineraryForm);
        if (domElements.eurInput) domElements.eurInput.addEventListener('input', convertCurrency);
        if (domElements.jpyInput) domElements.jpyInput.addEventListener('input', convertCurrency);
        if (domElements.suggestWordsButton) domElements.suggestWordsButton.addEventListener('click', suggestNewWords);
        if (domElements.calculateJrPassButton) { 
             domElements.calculateJrPassButton.addEventListener('click', calculateAndDisplayJrPassProfitability);
        }
        if (domElements.themeSelect) {
            domElements.themeSelect.addEventListener('change', (e) => applyTheme(e.target.value));
        }
        if (domElements.closeCityModalButton) domElements.closeCityModalButton.onclick = closeEditCityModal;
        if (domElements.saveCityModalButton) domElements.saveCityModalButton.onclick = saveCityDetails;
        window.onclick = function(event) { 
            if (domElements.editCityModal && event.target == domElements.editCityModal) {
                closeEditCityModal();
            }
        }
        updateConversionRateText();
    });
    </script>
</body>
</html>
