<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planificateur de Voyage Japon</title>
    <style>
        /* Styles g√©n√©raux - Th√®me Sombre (D√©faut initial, mais light est maintenant le d√©faut via JS) */
        :root {
            --bg-color: #1c1c1e; 
            --secondary-bg-color: #2c2c2e; 
            --tertiary-bg-color: #3a3a3c; 
            --text-color-primary: #ffffff; 
            --text-color-secondary: #e5e5ea; 
            --text-color-tertiary: #8e8e93; 
            --accent-color: #0a84ff; 
            --destructive-color: #ff3b30; 
            --highlight-color: #ff9f0a; 
            --border-color: #38383a; 
            --separator-color: #38383a; 
            --icon-color: var(--text-color-tertiary);
            --icon-active-color: var(--accent-color);
            --font-family-system: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        /* Th√®me Clair (Nouveau D√©faut via JS) */
        body.theme-light {
            --bg-color: #f2f2f7;
            --secondary-bg-color: #ffffff;
            --tertiary-bg-color: #e5e5ea;
            --text-color-primary: #000000;
            --text-color-secondary: #3c3c43; 
            --text-color-tertiary: #8A8A8E; 
            --accent-color: #007aff; /* Bleu Apple */
            --destructive-color: #ff3b30; /* Rouge Apple */
            --highlight-color: #ff9500; /* Orange Apple */
            --border-color: #c6c6c8;
            --separator-color: #d1d1d6; 
            --icon-color: var(--text-color-tertiary);
            --icon-active-color: var(--accent-color);
        }
        body.theme-light .button { /* Default button text for light theme */
            color: #FFFFFF; 
        }
        body.theme-light .button.city-edit-button {
            background-color: var(--accent-color); /* Bleu */
            color: #FFFFFF;
        }
        body.theme-light .button.city-ai-button {
            background-color: var(--highlight-color); /* Orange */
            color: #FFFFFF;
        }
        body.theme-light .button.suggest-food-button { /* Specific class for food button */
            background-color: #c0392b; /* Rouge fonc√© pour nourriture */
            color: #FFFFFF;
        }
        body.theme-light .button.secondary-button {
            color: var(--text-color-primary); /* Texte fonc√© sur fond clair */
            background-color: #e5e5ea; 
        }
         body.theme-light .button.secondary-button:hover {
            background-color: #d1d1d6;
        }
        body.theme-light .timeline-train-cost {
             color: #D35400; /* Orange plus fonc√© pour lisibilit√© */
        }


        /* Th√®me Brise Marine */
        body.theme-ocean-breeze {
            --bg-color: #E0F7FA; 
            --secondary-bg-color: #FFFFFF;
            --tertiary-bg-color: #B2EBF2; 
            --text-color-primary: #004D40; 
            --text-color-secondary: #00796B; 
            --text-color-tertiary: #4DB6AC; 
            --accent-color: #00BCD4; 
            --destructive-color: #E57373; 
            --highlight-color: #FFCA28; 
            --border-color: #B0BEC5; 
            --separator-color: #CFD8DC; 
        }
        body.theme-ocean-breeze .button {color: #004D40;} /* Texte fonc√© par d√©faut pour les boutons */
        body.theme-ocean-breeze .button.add-button,
        body.theme-ocean-breeze .button.city-edit-button {
             background-color: var(--accent-color); /* Cyan */
             color: #FFFFFF; /* Texte blanc sur cyan */
        }
        body.theme-ocean-breeze .button.ai-button,
        body.theme-ocean-breeze .button.city-ai-button {
             background-color: var(--highlight-color); /* Ambre */
             color: #004D40; /* Texte fonc√© sur ambre */
        }
        body.theme-ocean-breeze .button.suggest-food-button {
            background-color: #EF6C00; /* Orange fonc√© */
            color: #FFFFFF;
        }
         body.theme-ocean-breeze .button.secondary-button {
            color: var(--text-color-primary);
            background-color: var(--tertiary-bg-color);
        }
        body.theme-ocean-breeze .timeline-train-cost {
             color: #BF360C; 
        }


        /* Th√®me Fleur de Cerisier */
        body.theme-sakura-spring {
            --bg-color: #FFF0F5; 
            --secondary-bg-color: #FFFFFF;
            --tertiary-bg-color: #FFDDEE; 
            --text-color-primary: #5D4037; 
            --text-color-secondary: #8D6E63; 
            --text-color-tertiary: #A1887F; 
            --accent-color: #EC407A; 
            --destructive-color: #EF5350; 
            --highlight-color: #66BB6A; 
            --border-color: #D7CCC8; 
            --separator-color: #EFEBE9; 
        }
        body.theme-sakura-spring .button { color: #FFFFFF; }
        body.theme-sakura-spring .button.add-button,
        body.theme-sakura-spring .button.city-edit-button {
             background-color: var(--accent-color); /* Rose */
             color: #FFFFFF;
        }
        body.theme-sakura-spring .button.ai-button,
        body.theme-sakura-spring .button.city-ai-button {
             background-color: var(--highlight-color); /* Vert */
             color: #FFFFFF;
        }
        body.theme-sakura-spring .button.suggest-food-button {
            background-color: #D81B60; /* Magenta */
            color: #FFFFFF;
        }
        body.theme-sakura-spring .button.secondary-button {
            color: var(--text-color-primary);
            background-color: var(--tertiary-bg-color);
        }
         body.theme-sakura-spring .timeline-train-cost {
             color: #43A047; 
        }


        *, *::before, *::after {
            box-sizing: border-box;
        }

        html {
            height: 100%;
            overflow-y: hidden;
        }

        body {
            font-family: var(--font-family-system);
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color-primary);
            display: flex;
            flex-direction: column;
            height: 100%;
            transition: background-color 0.3s, color 0.3s;
        }

        .status-bar-placeholder {
            height: 20px; 
            background-color: var(--bg-color);
            flex-shrink: 0;
            transition: background-color 0.3s;
        }

        .main-content {
            flex: 1;
            overflow-y: auto; 
            position: relative;
            -webkit-overflow-scrolling: touch;
        }

        .screen {
            display: none;
            padding: 20px; 
            background-color: var(--bg-color); 
            transition: background-color 0.3s;
        }

        .screen.active {
            display: block;
        }

        .screen-title {
            font-size: 28px; 
            font-weight: 600; 
            color: var(--text-color-primary);
            margin-top: 0;
            margin-bottom: 25px;
            text-align: center;
        }

        .svg-icon {
            width: 20px; height: 20px;
            fill: currentColor;
            display: inline-block;
            vertical-align: middle;
        }
        .svg-icon.small { width: 16px; height: 16px; }
        .svg-icon.medium { width: 22px; height: 22px; }
        .svg-icon.large { width: 26px; height: 26px; }

        .tab-bar {
            display: flex;
            height: 65px; 
            border-top: 1px solid var(--border-color);
            background-color: var(--secondary-bg-color); 
            flex-shrink: 0;
            padding-bottom: env(safe-area-inset-bottom);
            position: relative;
            z-index: 100;
            transition: background-color 0.3s, border-color 0.3s;
        }

        .tab-item {
            flex: 1; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            cursor: pointer; padding-top: 5px; padding-bottom: 5px;
            border: none;
            background: none; transition: background-color 0.2s ease-in-out;
            color: var(--icon-color); 
        }
        .tab-item:hover { background-color: var(--tertiary-bg-color); }
        .tab-item .icon-placeholder { margin-bottom: 3px; height: 26px; display: flex; align-items: center; justify-content: center; }
        .tab-item .tab-label { font-size: 10px; color: var(--text-color-tertiary); }
        .tab-item.active { color: var(--icon-active-color); }
        .tab-item.active .tab-label { color: var(--accent-color); }

        .input-container, .form-group {
            display: flex;
            margin-bottom: 15px;
            gap: 10px; 
        }
        .form-group {
            flex-direction: column; 
            gap: 5px;
        }
        .form-group label {
            font-size: 14px;
            color: var(--text-color-secondary);
        }

        .text-input, .textarea-input, .date-input, .number-input, .select-input {
            flex: 1; background-color: var(--secondary-bg-color);
            color: var(--text-color-primary); border: 1px solid var(--border-color);
            border-radius: 8px; padding: 12px 15px; font-size: 16px;
            font-family: var(--font-family-system);
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }
        .text-input::placeholder, .textarea-input::placeholder { color: var(--text-color-tertiary); }
        .textarea-input { min-height: 60px; resize: vertical; }


        .button {
            color: #ffffff; padding: 12px 18px; border-radius: 8px;
            border: none; font-size: 16px; font-weight: 500; 
            cursor: pointer; display: flex; align-items: center;
            justify-content: center; gap: 8px;
            transition: background-color 0.2s ease, filter 0.2s ease;
        }
        .add-button { background-color: var(--accent-color); }
        .ai-button { background-color: var(--highlight-color); }
        .button:hover { filter: brightness(1.15); }
        .ai-button { margin-bottom: 20px; }
        .small-button { padding: 8px 12px; font-size: 14px; }
        .city-action-button { 
            padding: 6px 10px;
            font-size: 12px;
            min-width: auto; 
            flex-grow: 0; 
            flex-shrink: 1; 
            margin-top: 5px; /* Add some margin for wrapped buttons */
        }
        .secondary-button { background-color: var(--tertiary-bg-color); }


        .scroll-container { 
            overflow-y: auto; background-color: var(--secondary-bg-color); 
            border-radius: 10px; padding: 0px; margin-bottom: 10px;
            transition: background-color 0.3s;
        }
        .checklist-scroll-container { max-height: calc(100vh - 380px); } 
        .cities-scroll-container { max-height: calc(100vh - 270px); }
        .info-scroll-container { max-height: calc(100vh - 180px); }
        .itinerary-scroll-container { max-height: calc(100vh - 320px); } 


        .list-item { 
            display: flex; flex-direction: column;
            padding: 0; 
            background-color: transparent; 
            border-bottom: 1px solid var(--separator-color);
            transition: border-color 0.3s;
        }
        .list-item:last-child { border-bottom: none; }
        
        .list-item-main-content { 
            display: flex;
            align-items: center;
            padding: 12px 15px;
            width: 100%;
        }

        .checklist-item-content { display: flex; align-items: center; flex-grow: 1; cursor: pointer; }
        .checkbox-placeholder { 
            width: 22px; height: 22px; margin-right: 15px; 
            color: var(--accent-color); flex-shrink: 0; display: flex;
            align-items: center; justify-content: center;
        }
        .checklist-item-text {
            font-size: 17px; color: var(--text-color-secondary); line-height: 1.4; word-break: break-word;
        }
        .checklist-item-text.completed { text-decoration: line-through; color: var(--text-color-tertiary); }
        
        .checklist-item-description-area {
            padding: 0px 15px 15px 52px; 
            display: none; 
        }
        .checklist-item-description-area.expanded {
            display: block;
        }
        .checklist-item-description-area textarea { width: 100%;}

        .expand-icon-placeholder {
            margin-left: 10px;
            color: var(--text-color-tertiary);
            cursor: pointer;
        }

        .delete-button-placeholder { 
            padding: 8px; background: none; border: none;
            cursor: pointer; color: var(--destructive-color);
            margin-left: auto; flex-shrink: 0; display: flex;
            align-items: center; justify-content: center;
            transition: opacity 0.2s ease;
        }
        .delete-button-placeholder:hover { opacity: 0.7; }

        .city-container { 
            background-color: var(--secondary-bg-color); 
            border-radius: 10px; overflow: hidden; margin-bottom: 10px; 
            transition: background-color 0.3s;
        }
        .city-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px; background-color: var(--tertiary-bg-color); 
            cursor: pointer; border-bottom: 1px solid var(--border-color); 
            transition: background-color 0.3s, border-color 0.3s;
        }
        .city-header:hover { background-color: #4a4a4c; }
        body.theme-light .city-header:hover { background-color: #dcdcdf; }

        .city-header-main { flex-grow: 1; display: flex; align-items: center; }
        .city-name { font-size: 20px; font-weight: 500; color: var(--text-color-primary); }
        .city-color-indicator {
            width: 12px; height: 12px; border-radius: 50%;
            margin-right: 8px; display: inline-block;
            border: 1px solid var(--border-color);
        }
        .city-expand-icon-placeholder { 
            width: 20px; height: 20px; color: var(--text-color-tertiary);
            margin-left: 12px; display: flex; align-items: center; justify-content: center;
        }
        .city-actions { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            flex-wrap: wrap; 
            justify-content: flex-end; 
            flex-shrink: 0; /* Prevent actions div from shrinking too much */
            margin-left: 10px; /* Add some space from city name if wrapping */
        }
        .city-actions .button { 
            padding: 6px 10px;
            font-size: 12px;
            min-width: auto; 
            flex-grow: 0; 
            flex-shrink: 0; /* Prevent individual buttons from shrinking too much */
        }

        .delete-city-button-placeholder { padding: 8px; }


        .attractions-container { padding: 0; background-color: var(--secondary-bg-color); display: none; }
        .attractions-container.expanded { display: block; }
        .attraction-category-title {
            font-size: 16px; font-weight: 600; color: var(--text-color-secondary);
            background-color: var(--tertiary-bg-color); 
            padding: 10px 15px; margin: 0;
            border-bottom: 1px solid var(--border-color);
            display: flex; align-items: center;
        }
        .category-color-indicator {
            width: 10px; height: 10px; border-radius: 3px;
            margin-right: 8px; display: inline-block;
        }
        
        .attraction-item-wrapper {
            display: flex;
            align-items: flex-start; 
            padding: 12px 15px;
            border-bottom: 1px solid var(--separator-color);
        }
        .attraction-item-wrapper:last-of-type {
             border-bottom: none;
        }
        .attraction-checkbox-placeholder {
             width: 22px; height: 22px; margin-right: 15px; 
            color: var(--accent-color); flex-shrink: 0; display: flex;
            align-items: center; justify-content: center;
            margin-top: 2px; 
        }

        .attraction-content { 
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .attraction-text { 
            font-size: 17px; color: var(--text-color-secondary); 
            line-height: 1.4; word-break: break-word;
            cursor: pointer;
            font-weight: 500; 
            font-style: normal !important; 
        }
        .attraction-text.completed { text-decoration: line-through; color: var(--text-color-tertiary); }
        .attraction-text.ai-suggestion { color: var(--highlight-color); }
        
        .attraction-description {
            font-size: 14px;
            color: var(--text-color-tertiary);
            margin-top: 4px;
            margin-bottom: 6px;
            line-height: 1.5;
        }
        .attraction-price {
            font-size: 0.9em; color: var(--text-color-tertiary);
            font-style: normal; white-space: nowrap;
            margin-bottom: 8px;
        }
         .attraction-text.ai-suggestion .attraction-price,
         .attraction-text.ai-suggestion ~ .attraction-price, 
         .ai-suggestion .attraction-price { 
             color: var(--highlight-color); 
        }


        .map-link-button {
            background: none; border: none; color: var(--accent-color);
            cursor: pointer; padding: 4px 0; 
            display: flex; align-items: center; gap: 5px; font-size: 14px;
        }
        .map-link-button .svg-icon { width: 16px; height: 16px;}
        .map-link-button:hover { filter: brightness(1.2); }

        .attraction-actions { 
            margin-left: auto;
            padding-left: 10px; 
            flex-shrink: 0;
        }


        .add-attraction-section-title {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-color-secondary);
            padding: 15px 15px 5px 15px; 
            margin: 0;
            border-top: 1px solid var(--border-color); 
        }
        .add-attraction-form {
            padding: 0 15px 15px 15px; 
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .add-attraction-form input, .add-attraction-form textarea { margin-bottom: 5px; }


        .info-section {
            margin-bottom: 20px; padding: 15px;
            background-color: var(--secondary-bg-color); 
            border-radius: 10px; border: 1px solid var(--border-color);
            transition: background-color 0.3s, border-color 0.3s;
        }
        .info-section-title {
            font-size: 18px; font-weight: 600;
            color: var(--text-color-primary); margin-bottom: 12px;
        }
        .info-list-item { font-size: 16px; color: var(--text-color-secondary); line-height: 1.6; }
        .info-small-text { font-size: 13px; color: var(--text-color-tertiary); margin-top: 8px; }
        .useful-words-list .info-list-item { display: flex; align-items: center; justify-content: space-between; }
        .useful-words-list .info-list-item.ai-suggestion { color: var(--highlight-color); }
        .speaker-icon-placeholder { 
            width: 18px; height: 18px; margin-left: 10px; cursor: pointer;
            color: var(--accent-color); transition: opacity 0.2s ease;
            display: flex; align-items: center; justify-content: center;
        }
        .speaker-icon-placeholder:hover { opacity: 0.7; }

        .converter-row { display: flex; align-items: center; gap: 10px; }
        .converter-container { display: flex; flex-direction: column; gap: 12px; }
        .converter-row input[type="number"] {
            flex-grow: 1; padding: 10px 12px; 
            background-color: var(--tertiary-bg-color); 
            color: var(--text-color-primary); border: 1px solid var(--border-color);
            border-radius: 6px; font-size: 16px;
        }
        .converter-row span { font-size: 16px; color: var(--text-color-secondary); }

        .loading-message, .error-message {
            position: fixed; bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(50, 50, 50, 0.85); 
            backdrop-filter: blur(5px); color: white;
            padding: 12px 22px; border-radius: 20px; 
            z-index: 1000; display: none; font-size: 14px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .error-message { background-color: rgba(200, 50, 50, 0.85); }

        /* Itinerary Styles */
        #itineraryForm {
            background-color: var(--secondary-bg-color);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .itinerary-form-buttons {
            display: flex;
            gap: 10px;
        }
        .itinerary-path-container {
            margin-bottom: 20px;
            padding: 10px;
            background-color: var(--secondary-bg-color);
            border-radius: 8px;
        }
        .itinerary-path-item {
            display: inline-flex; 
            align-items: center;
            padding: 5px 8px;
            border-radius: 6px;
            margin-right: 5px; 
            margin-bottom: 5px; 
            font-size: 14px;
            color: var(--text-color-primary); 
        }
        .itinerary-path-item .svg-icon { 
            margin-left: 8px;
            margin-right: 8px;
            fill: var(--text-color-tertiary);
        }


        .timeline {
            position: relative;
            padding: 20px 0;
        }
        .timeline::before { 
            content: '';
            position: absolute;
            left: 20px; 
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: var(--tertiary-bg-color);
        }
        .timeline-item {
            position: relative;
            margin-bottom: 20px;
            padding-left: 50px; 
        }
        .timeline-item:last-child {
            margin-bottom: 0;
        }
        .timeline-dot {
            position: absolute;
            left: 12px; 
            top: 0;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background-color: var(--accent-color);
            border: 2px solid var(--bg-color); 
        }
         .timeline-item-content {
            background-color: var(--secondary-bg-color);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            position: relative; 
        }
        .timeline-city { font-size: 18px; font-weight: 600; color: var(--text-color-primary); margin-bottom: 5px; }
        .timeline-dates { font-size: 14px; color: var(--text-color-secondary); margin-bottom: 8px; }
        .timeline-duration { font-size: 13px; color: var(--text-color-tertiary); margin-bottom: 8px; }
        .timeline-notes { font-size: 14px; color: var(--text-color-secondary); margin-bottom: 8px; }
        .timeline-train-cost { font-size: 13px; color: var(--highlight-color); font-style: italic; }
        .timeline-item-actions { display: flex; gap: 8px; margin-top:10px; align-items: center; justify-content: flex-end; }
        .timeline-item-actions button { margin-right: 0px;} 
        .reorder-buttons {
            position: absolute;
            top: 15px; 
            left: -40px; 
            display: flex;
            flex-direction: column;
            gap: 8px; 
            z-index: 1; 
        }
        .reorder-buttons button {
            background: none; border: none; padding: 0; 
            cursor: pointer; color: var(--text-color-tertiary);
            display: flex; align-items: center; justify-content: center;
        }
        .reorder-buttons button .svg-icon { width: 20px; height: 20px;} 
        .reorder-buttons button:hover { color: var(--accent-color); }


        /* JR Pass Calculator Styles */
        #jrPassResultContainer {
            margin-top: 15px;
            padding: 15px;
            background-color: var(--tertiary-bg-color);
            border-radius: 8px;
        }
        #jrPassResultContainer p, #jrPassResultContainer li {
            font-size: 15px;
            line-height: 1.6;
            color: var(--text-color-secondary);
        }
        #jrPassResultContainer strong {
            color: var(--text-color-primary);
        }
        #jrPassResultContainer .recommendation {
            font-weight: 600;
            margin-top: 10px;
        }
        #jrPassResultContainer .recommendation.profitable {
            color: var(--highlight-color);
        }
        #jrPassResultContainer .recommendation.not-profitable {
            color: var(--text-color-secondary);
        }
         #jrPassResultContainer ul {
            list-style-type: disc;
            padding-left: 20px;
        }
        
        /* Checklist Sort Buttons */
        .sort-buttons-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap; 
        }
        .sort-buttons-container .button {
            font-size: 13px;
            padding: 6px 10px;
            background-color: var(--tertiary-bg-color);
            color: var(--text-color-secondary);
        }
        .sort-buttons-container .button.active {
            background-color: var(--accent-color);
            color: #ffffff;
        }


        /* City Edit Modal (Basic Styling) */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1001; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.6); 
            padding-top: 60px;
        }
        .modal-content {
            background-color: var(--secondary-bg-color);
            margin: 5% auto; 
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            width: 80%; 
            max-width: 500px;
        }
        .modal-content h3 { color: var(--text-color-primary); margin-top: 0;}
        .close-button {
            color: var(--text-color-tertiary);
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: var(--text-color-primary);
            text-decoration: none;
            cursor: pointer;
        }
        .color-palette {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .color-option.selected {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px var(--accent-color);
        }


    </style>
</head>
<body>
    <div class="status-bar-placeholder"></div>

    <div class="main-content">
        <div id="loadingMessage" class="loading-message">Chargement des suggestions IA...</div>
        <div id="errorMessage" class="error-message">Une erreur est survenue.</div>

        <div id="checklistScreen" class="screen active">
            <h1 class="screen-title">Checklist avant d√©part</h1>
            <div class="input-container">
                <input type="text" id="newItemInput" class="text-input" placeholder="Ajouter une t√¢che...">
                <button id="addItemButton" class="button add-button">Ajouter</button>
            </div>
             <div class="sort-buttons-container" id="checklistSortButtons">
                <button class="button" data-sort="recent">Par ajout (r√©cent)</button>
                <button class="button" data-sort="oldest">Par ajout (ancien)</button>
                <button class="button" data-sort="incomplete">Non compl√©t√©es</button>
                <button class="button" data-sort="complete">Compl√©t√©es</button>
            </div>
            <button id="suggestTasksButton" class="button ai-button">
                <span id="aiButtonSuggestTaskIconPlaceholder"></span>
                Sugg√©rer des t√¢ches
            </button>
            <div id="checklistItemsContainer" class="scroll-container checklist-scroll-container"></div>
        </div>

        <div id="citiesScreen" class="screen">
            <h1 class="screen-title">Villes et activit√©s</h1>
            <div class="input-container"> 
                <input type="text" id="newCityInput" class="text-input" placeholder="Nom de la nouvelle ville...">
                <button id="addCityButton" class="button add-button">Ajouter Ville</button>
            </div>
            <div id="citiesListContainer" class="cities-scroll-container" style="padding:0; background-color: transparent;"></div>
        </div>
        
        <div id="itineraryScreen" class="screen">
            <h1 class="screen-title">Mon itin√©raire (15 Nov - 29 Nov 2025)</h1>
            <div id="itineraryPathContainer" class="itinerary-path-container">
                </div>
            <form id="itineraryForm">
                <input type="hidden" id="editingItineraryStopId"> 
                <div class="form-group">
                    <label for="itineraryCitySelect">Ville :</label>
                    <select id="itineraryCitySelect" class="select-input"></select>
                </div>
                <div class="form-group">
                    <label for="itineraryStartDate">Date de d√©but :</label>
                    <input type="date" id="itineraryStartDate" class="date-input" value="2025-11-15" min="2025-11-15" max="2025-11-29">
                </div>
                <div class="form-group">
                    <label for="itineraryDurationNights">Nombre de nuits :</label>
                    <input type="number" id="itineraryDurationNights" class="number-input" value="3" min="1">
                </div>
                 <div class="form-group">
                    <label for="itineraryNotes">Notes (optionnel) :</label>
                    <textarea id="itineraryNotes" class="textarea-input" placeholder="Ex: R√©servation h√¥tel XYZ, vol √† 14h..."></textarea>
                </div>
                <div class="itinerary-form-buttons">
                    <button type="submit" id="addItineraryStopButton" class="button add-button">Ajouter √âtape</button>
                    <button type="button" id="cancelEditItineraryButton" class="button secondary-button" style="display:none;">Annuler Modification</button>
                </div>
            </form>
            <div id="itineraryTimelineContainer" class="itinerary-scroll-container timeline">
                </div>
        </div>

        <div id="infoScreen" class="screen">
            <h1 class="screen-title">Infos pratiques</h1>
            <div class="info-scroll-container">
                <div class="info-section">
                    <h2 class="info-section-title">Param√®tres d'affichage</h2>
                    <div class="form-group">
                        <label for="themeSelect">Th√®me de l'application :</label>
                        <select id="themeSelect" class="select-input">
                            <option value="light">Th√®me Clair (D√©faut)</option>
                            <option value="dark">Th√®me Sombre</option>
                            <option value="ocean-breeze">Brise Marine</option>
                            <option value="sakura-spring">Fleur de Cerisier</option>
                        </select>
                    </div>
                </div>

                <div class="info-section">
                    <h2 class="info-section-title">Convertisseur de devises</h2>
                    <div class="converter-container">
                        <div class="converter-row">
                            <input type="number" id="eurInput" placeholder="Montant en EUR">
                            <span>EUR</span>
                        </div>
                        <div class="converter-row">
                            <input type="number" id="jpyInput" placeholder="Montant en JPY">
                            <span>JPY</span>
                        </div>
                    </div>
                    <p class="info-small-text" id="conversionRateText">Taux : 1 EUR ‚âà 160 JPY</p>
                </div>
                <div class="info-section" id="usefulWordsSection">
                    <h2 class="info-section-title">Quelques mots utiles</h2>
                    <div id="usefulWordsList" class="useful-words-list"></div>
                    <button id="suggestWordsButton" class="button ai-button" style="margin-top: 15px; font-size: 14px; padding: 10px 15px; width:100%;">
                        <span id="aiButtonSuggestWordIconPlaceholder"></span>
                        Plus de mots
                    </button>
                </div>

                <div class="info-section">
                    <h2 class="info-section-title">Japan Rail Pass</h2>
                    <p class="info-list-item">‚Ä¢ Forfait √©conomique pour voyager en train √† travers le Japon.</p>
                    <p class="info-list-item">‚Ä¢ Valable sur la plupart des lignes JR, y compris de nombreux Shinkansen (trains √† grande vitesse).</p>
                    <p class="info-list-item">‚Ä¢ Disponible pour des dur√©es de 7, 14, ou 21 jours cons√©cutifs.</p>
                    <p class="info-list-item">‚Ä¢ Prix (approximatifs, peuvent varier) :
                        <ul>
                            <li>7 jours : ~¬•50,000</li>
                            <li>14 jours : ~¬•80,000</li>
                            <li>21 jours : ~¬•100,000</li>
                        </ul>
                    </p>
                     <p class="info-list-item">‚Ä¢ Doit g√©n√©ralement √™tre achet√© avant votre arriv√©e au Japon (bien que des options d'achat sur place existent, souvent plus ch√®res).</p>
                    <h3 style="margin-top: 20px; font-size: 16px; font-weight: 500;">Calculateur de rentabilit√© :</h3>
                    <p class="info-text" style="margin-bottom:10px;">Cet outil vous aide √† estimer si un JR Pass serait rentable pour votre voyage, bas√© sur l'itin√©raire que vous avez d√©fini.</p>
                    <button id="calculateJrPassButton" class="button add-button" style="margin-bottom: 15px; width: 100%;">Calculer pour mon itin√©raire</button>
                    <div id="jrPassResultContainer" style="display: none;">
                        </div>
                </div>

                <div class="info-section">
                    <h2 class="info-section-title">Num√©ros d'urgence</h2>
                    <p class="info-list-item">‚Ä¢ Police : 110</p>
                    <p class="info-list-item">‚Ä¢ Pompiers / Ambulance : 119</p>
                    <p class="info-list-item">‚Ä¢ Japan Helpline (anglais) : 0570-000-911</p>
                </div>
            </div>
        </div>
    </div>

    <div id="editCityModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeCityModal">√ó</span>
            <h3>Modifier les d√©tails de la ville</h3>
            <input type="hidden" id="editingCityIdModal">
            <div class="form-group">
                <label for="cityNameModalInput">Nom de la ville :</label>
                <input type="text" id="cityNameModalInput" class="text-input">
            </div>
            <div class="form-group">
                <label for="cityColorPalette">Couleur :</label>
                <div id="cityColorPalette" class="color-palette">
                    </div>
                <input type="hidden" id="cityColorModalInputHidden">
            </div>
            <button id="saveCityModalButton" class="button add-button">Sauvegarder</button>
        </div>
    </div>


    <div class="tab-bar">
        <button class="tab-item active" data-screen="checklistScreen">
            <span class="icon-placeholder" id="tabIconChecklist"></span>
            <span class="tab-label">Checklist</span>
        </button>
        <button class="tab-item" data-screen="citiesScreen">
            <span class="icon-placeholder" id="tabIconCities"></span>
            <span class="tab-label">Villes & Activit√©s</span>
        </button>
        <button class="tab-item" data-screen="itineraryScreen">
            <span class="icon-placeholder" id="tabIconItinerary"></span>
            <span class="tab-label">Itin√©raire</span>
        </button>
        <button class="tab-item" data-screen="infoScreen">
            <span class="icon-placeholder" id="tabIconInfo"></span>
            <span class="tab-label">Infos</span>
        </button>
    </div>

    <script>
        // --- D√©finitions des Ic√¥nes SVG ---
        const icons = { 
            checklist: '<svg class="svg-icon large" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M14 2H6C4.9 2 4 2.9 4 4V20C4 21.1 4.9 22 6 22H18C19.1 22 20 21.1 20 20V8L14 2ZM18 20H6V4H13V9H18V20ZM8 11H16V13H8V11ZM8 15H16V17H8V15Z"/></svg>',
            cities: '<svg class="svg-icon large" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C8.13 2 5 5.13 5 9C5 14.25 12 22 12 22C12 22 19 14.25 19 9C19 5.13 15.87 2 12 2ZM12 11.5C10.62 11.5 9.5 10.38 9.5 9C9.5 7.62 10.62 6.5 12 6.5C13.38 6.5 14.5 7.62 14.5 9C14.5 10.38 13.38 11.5 12 11.5Z"/></svg>',
            info: '<svg class="svg-icon large" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM12 17C11.45 17 11 16.55 11 16V12C11 11.45 11.45 11 12 11C12.55 11 13 11.45 13 12V16C13 16.55 12.55 17 12 17ZM12 9C11.45 9 11 8.55 11 8C11 7.45 11.45 7 12 7C12.55 7 13 7.45 13 8C13 8.55 12.55 9 12 9Z"/></svg>',
            itinerary: '<svg class="svg-icon large" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M18.24 13.76L12 10.03L5.76 13.76L4 12.59L12 7.41l8 5.18l-1.76 1.17zM12 3C6.48 3 2 5.24 2 8c0 2.24 2.95 4.12 7 4.87V19H7v2h10v-2h-2v-6.13c4.05-.75 7-2.63 7-4.87c0-2.76-4.48-5-10-5zm0 2c3.78 0 7.35 1.53 8.91 3.09C19.26 9.04 16.29 10 12 10s-7.26-.96-8.91-1.91C4.65 6.53 8.22 5 12 5z"/></svg>',
            checkboxEmpty: '<svg class="svg-icon medium" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M19 5V19H5V5H19ZM19 3H5C3.9 3 3 3.9 3 5V19C3 20.1 3.9 21 5 21H19C20.1 21 21 20.1 21 19V5C21 3.9 20.1 3 19 3Z"/></svg>',
            checkboxChecked: '<svg class="svg-icon medium" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M19 3H5C3.9 3 3 3.9 3 5V19C3 20.1 3.9 21 5 21H19C20.1 21 21 20.1 21 19V5C21 3.9 20.1 3 19 3ZM10 17L5 12L6.41 10.59L10 14.17L17.59 6.58L19 8L10 17Z"/></svg>',
            trash: '<svg class="svg-icon" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M6 19C6 20.1 6.9 21 8 21H16C17.1 21 18 20.1 18 19V7H6V19ZM19 4H15.5L14.5 3H9.5L8.5 4H5V6H19V4Z"/></svg>',
            plus: '<svg class="svg-icon" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M19 13H13V19H11V13H5V11H11V5H13V11H19V13Z"/></svg>',
            minus: '<svg class="svg-icon" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M19 13H5V11H19V13Z"/></svg>',
            sparkle: '<svg class="svg-icon small" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 2L9.5 8.5L3 10L9.5 11.5L12 18L14.5 11.5L21 10L14.5 8.5L12 2Z"/></svg>',
            speaker: '<svg class="svg-icon small" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M3 9V15H7L12 20V4L7 9H3ZM16.5 12C16.5 10.23 15.48 8.71 14 7.97V16.02C15.48 15.29 16.5 13.77 16.5 12ZM14 3.23V5.29C16.89 6.15 19 8.83 19 12C19 15.17 16.89 17.84 14 18.7V20.77C18.01 19.86 21 16.28 21 12C21 7.72 18.01 4.14 14 3.23Z"/></svg>',
            chevronDown: '<svg class="svg-icon small" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6l-6-6l1.41-1.41z"/></svg>',
            chevronUp: '<svg class="svg-icon small" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6l-6 6l1.41 1.41z"/></svg>',
            mapMarker: '<svg class="svg-icon small" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>',
            calendar: '<svg class="svg-icon small" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M17 12h-5v5h5v-5zM16 1v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2h-1V1h-2zm3 18H5V8h14v11z"/></svg>',
            edit: '<svg class="svg-icon small" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>',
            arrowUp: '<svg class="svg-icon small" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6l-6 6z"/></svg>',
            arrowDown: '<svg class="svg-icon small" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6l-6 6z"/></svg>',
            food: '<svg class="svg-icon small" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M16 6v8h3v8h-3v-2h-2v2H8v-2H6v2H3V14h3V6H3V4h3V2h8v2h3v2h-3zm-2 0H8v6h6V6zm0 8H8v6h6v-6z"/></svg>', 
            route: '<svg class="svg-icon large" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor"><path d="M19.41,6.59 C19.02,6.2 18.39,6.2 18,6.59 L12,12.59 L6,6.59 C5.61,6.2 4.98,6.2 4.59,6.59 C4.2,6.98 4.2,7.61 4.59,8 L11.29,14.71 C11.68,15.1 12.31,15.1 12.7,14.71 L19.41,8 C19.8,7.61 19.8,6.98 19.41,6.59 Z M12,2 C6.48,2 2,6.48 2,12 C2,17.52 6.48,22 12,22 C17.52,22 22,17.52 22,12 C22,6.48 17.52,2 12,2 Z M12,20 C7.59,20 4,16.41 4,12 C4,7.59 7.59,4 12,4 C16.41,4 20,7.59 20,12 C20,16.41 16.41,20 12,20 Z"/></svg>' 
        };

        const LOCAL_STORAGE_KEY = 'japanTripPlannerData_v4'; 
        let currentExchangeRate = 160; 
        
        const TRIP_START_DATE = '2025-11-15';
        const TRIP_END_DATE = '2025-11-29';

        let checklistItems = [];
        let citiesData = [];
        let usefulWords = [];
        let itineraryData = [];
        let editingItineraryStopId = null; 
        let japaneseVoice = null; 
        let currentChecklistSort = 'recent'; 
        
        const jrPassPrices = { 
            7: 50000,
            14: 80000,
            21: 100000
        };

        const cityColorPalette = [
            { name: "Rouge Fuji", value: "#D90429" }, { name: "Rose Sakura", value: "#FFB7C5" },
            { name: "Orange Yuzu", value: "#FF8C00" }, { name: "Jaune Ginkgo", value: "#FFD700" },
            { name: "Vert Matcha", value: "#6B8E23" }, { name: "Bleu Aizome", value: "#0072BB" },
            { name: "Violet Ajisai", value: "#8A2BE2" }, { name: "Gris Kumo", value: "#808080" },
            { name: "Brun Sugi", value: "#A0522D" }, { name: "Noir Sumi", value: "#2F4F4F" }
        ];


        const activityCategoryStyles = {
            "Culturel": { color: "#8e44ad", icon: "üèõÔ∏è" }, 
            "Nature": { color: "#27ae60", icon: "üå≥" },   
            "Nourriture": { color: "#e67e22", icon: "üçú" },
            "Shopping": { color: "#3498db", icon: "üõçÔ∏è" }, 
            "Monument": { color: "#7f8c8d", icon: "üóø" }, 
            "Point d'int√©r√™t": { color: "#f1c40f", icon: "üìç" }, 
            "Nourriture & Restaurants": { color: "#e74c3c", icon: "üçΩÔ∏è" }, 
            "Suggestion": { color: "#95a5a6", icon: "üí°" }, 
            "Autre": { color: "#bdc3c7", icon: "‚û°Ô∏è" } 
        };


        const domElements = {
            body: document.body,
            screens: document.querySelectorAll('.screen'),
            tabItems: document.querySelectorAll('.tab-item'),
            checklistItemsContainer: document.getElementById('checklistItemsContainer'),
            checklistSortButtonsContainer: document.getElementById('checklistSortButtons'),
            newItemInput: document.getElementById('newItemInput'),
            addItemButton: document.getElementById('addItemButton'),
            suggestTasksButton: document.getElementById('suggestTasksButton'),
            aiButtonSuggestTaskIconPlaceholder: document.getElementById('aiButtonSuggestTaskIconPlaceholder'),
            citiesListContainer: document.getElementById('citiesListContainer'),
            newCityInput: document.getElementById('newCityInput'),
            addCityButton: document.getElementById('addCityButton'),
            loadingMessage: document.getElementById('loadingMessage'),
            errorMessage: document.getElementById('errorMessage'),
            eurInput: document.getElementById('eurInput'),
            jpyInput: document.getElementById('jpyInput'),
            conversionRateText: document.getElementById('conversionRateText'),
            usefulWordsListDiv: document.getElementById('usefulWordsList'),
            suggestWordsButton: document.getElementById('suggestWordsButton'),
            aiButtonSuggestWordIconPlaceholder: document.getElementById('aiButtonSuggestWordIconPlaceholder'),
            tabIconChecklist: document.getElementById('tabIconChecklist'),
            tabIconCities: document.getElementById('tabIconCities'),
            tabIconItinerary: document.getElementById('tabIconItinerary'),
            tabIconInfo: document.getElementById('tabIconInfo'),
            itineraryForm: document.getElementById('itineraryForm'),
            editingItineraryStopIdInput: document.getElementById('editingItineraryStopId'),
            itineraryCitySelect: document.getElementById('itineraryCitySelect'),
            itineraryStartDateInput: document.getElementById('itineraryStartDate'),
            itineraryDurationNightsInput: document.getElementById('itineraryDurationNights'),
            itineraryNotesInput: document.getElementById('itineraryNotes'),
            addItineraryStopButton: document.getElementById('addItineraryStopButton'),
            cancelEditItineraryButton: document.getElementById('cancelEditItineraryButton'),
            itineraryTimelineContainer: document.getElementById('itineraryTimelineContainer'),
            itineraryPathContainer: document.getElementById('itineraryPathContainer'),
            calculateJrPassButton: document.getElementById('calculateJrPassButton'),
            jrPassResultContainer: document.getElementById('jrPassResultContainer'),
            themeSelect: document.getElementById('themeSelect'),
            editCityModal: document.getElementById('editCityModal'),
            closeCityModalButton: document.getElementById('closeCityModal'),
            editingCityIdModalInput: document.getElementById('editingCityIdModal'),
            cityNameModalInput: document.getElementById('cityNameModalInput'),
            cityColorPaletteDiv: document.getElementById('cityColorPalette'),
            cityColorModalInputHidden: document.getElementById('cityColorModalInputHidden'),
            saveCityModalButton: document.getElementById('saveCityModalButton'),
        };
        
        function generateId(prefix = 'item') {
            return `${prefix}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
        }

        function saveData() {
            try {
                const dataToSave = {
                    checklist: checklistItems,
                    cities: citiesData,
                    words: usefulWords,
                    itinerary: itineraryData,
                    theme: domElements.body.className 
                };
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(dataToSave));
            } catch (error) {
                console.error("Erreur lors de la sauvegarde des donn√©es:", error);
                showErrorMessage("Impossible de sauvegarder les donn√©es.");
            }
        }

        function loadData() {
            const savedData = localStorage.getItem(LOCAL_STORAGE_KEY);
            let currentTheme = 'theme-light'; // Default to light theme class name
            if (savedData) {
                try {
                    const parsedData = JSON.parse(savedData);
                    checklistItems = (parsedData.checklist || []).map(item => ({ ...item, id: item.id || generateId('checklist'), description: item.description || '', isExpanded: item.isExpanded || false, createdAt: item.createdAt || Date.now() }));
                    citiesData = (parsedData.cities || []).map(city => ({ 
                        ...city, 
                        id: city.id || generateId('city'),
                        color: city.color || getRandomColor(), 
                        attractions: (city.attractions || []).map(attr => ({...attr, id: attr.id || generateId('attr'), description: attr.description || ''})) 
                    }));
                    usefulWords = (parsedData.words || []).map(word => ({ ...word, id: word.id || generateId('word') }));
                    itineraryData = (parsedData.itinerary || []).map(stop => ({ ...stop, id: stop.id || generateId('itinerary')}));
                    
                    currentTheme = parsedData.theme || 'theme-light'; 

                } catch (error) {
                    console.error("Erreur lors du chargement des donn√©es:", error);
                    initializeDefaultDataArrays();
                }
            } else {
                 initializeDefaultDataArrays();
            }
            applyTheme(currentTheme); 
            if (domElements.themeSelect) domElements.themeSelect.value = currentTheme.replace('theme-','');
        }

        function initializeDefaultDataArrays() {
            checklistItems = [ 
                { id: generateId('checklist'), text: 'R√©server les vols', completed: false, description: '', isExpanded: false, createdAt: Date.now() - 20000 }, 
                { id: generateId('checklist'), text: 'R√©server les h√©bergements', completed: false, description: '', isExpanded: false, createdAt: Date.now() - 10000 }
            ];
            citiesData = [ 
                { id: generateId('city'), name: 'Tokyo', color: getRandomColor(), isExpanded: false, attractions: [
                    { id: generateId('attr'), text: 'Travers√©e de Shibuya', category: 'Point d\'int√©r√™t', price: 'Gratuit', completed: false, description: 'Le passage pi√©ton le plus fr√©quent√© au monde.' },
                    { id: generateId('attr'), text: 'Tour de Tokyo', category: 'Monument', price: '¬•¬•', completed: false, description: 'Tour d\'observation et de communication inspir√©e de la Tour Eiffel.' }
                ]},
                { id: generateId('city'), name: 'Kyoto', color: getRandomColor(), isExpanded: false, attractions: [
                    { id: generateId('attr'), text: 'Kinkaku-ji (Pavillon d\'Or)', category: 'Culturel', price: '¬•', completed: false, description: 'C√©l√®bre temple Zen recouvert de feuilles d\'or.' }
                ]}
            ];
            usefulWords = [ 
                { id: generateId('word'), text: "Bonjour", translation: "„Åì„Çì„Å´„Å°„ÅØ", isAISuggestion: false, lang: "ja-JP" },
                { id: generateId('word'), text: "Merci", translation: "„ÅÇ„Çä„Åå„Å®„ÅÜ", isAISuggestion: false, lang: "ja-JP" },
                { id: generateId('word'), text: "S'il vous pla√Æt", translation: "„Åä„Å≠„Åå„ÅÑ„Åó„Åæ„Åô", isAISuggestion: false, lang: "ja-JP" }
            ];
            itineraryData = [];
        }
        
        function showLoadingMessage(message = "Chargement...") {
            domElements.loadingMessage.textContent = message;
            domElements.loadingMessage.style.display = 'block';
            domElements.errorMessage.style.display = 'none';
        }
        function hideLoadingMessage() { domElements.loadingMessage.style.display = 'none'; }
        function showErrorMessage(message = "Une erreur est survenue.") {
            domElements.errorMessage.textContent = message;
            domElements.errorMessage.style.display = 'block';
            hideLoadingMessage();
            setTimeout(() => { domElements.errorMessage.style.display = 'none'; }, 5000);
        }

        async function generateContentWithGemini(prompt) {
            showLoadingMessage("L'IA r√©fl√©chit...");
            const apiKey = "AIzaSyBu83wrvYvz9sQ3UU1E-3q4wokfQCcobuw";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) { 
                    const errorData = await response.json(); 
                    console.error("Gemini API Error Full Response:", errorData);
                    throw new Error(errorData?.error?.message || `Erreur API Gemini (${response.status})`); 
                }
                const result = await response.json();
                hideLoadingMessage();
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) { 
                    return result.candidates[0].content.parts[0].text; 
                }
                console.warn("Gemini API - R√©ponse inattendue:", result);
                throw new Error("R√©ponse IA inattendue ou vide.");
            } catch (error) { 
                console.error("Erreur fonction generateContentWithGemini:", error); 
                showErrorMessage(error.message); 
                hideLoadingMessage(); 
                throw error; 
            }
        }

        function setActiveScreen(screenId) {
            domElements.screens.forEach(screen => screen.classList.toggle('active', screen.id === screenId));
            domElements.tabItems.forEach(tab => tab.classList.toggle('active', tab.dataset.screen === screenId));
            if (screenId === 'itineraryScreen') {
                populateItineraryCitySelect();
                renderItinerary();
                resetItineraryForm(); 
            }
             if (screenId === 'infoScreen' && domElements.calculateJrPassButton) { 
                domElements.calculateJrPassButton.addEventListener('click', calculateAndDisplayJrPassProfitability);
            }
            if (screenId === 'checklistScreen' && domElements.checklistSortButtonsContainer) {
                 updateActiveSortButton();
            }
        }
        domElements.tabItems.forEach(tab => tab.addEventListener('click', () => setActiveScreen(tab.dataset.screen)));

        // --- Checklist Fonctions ---
        function sortChecklistItems() {
            switch (currentChecklistSort) {
                case 'recent':
                    checklistItems.sort((a, b) => b.createdAt - a.createdAt);
                    break;
                case 'oldest':
                    checklistItems.sort((a, b) => a.createdAt - b.createdAt);
                    break;
                case 'incomplete':
                    checklistItems.sort((a, b) => a.completed - b.completed || b.createdAt - a.createdAt);
                    break;
                case 'complete':
                    checklistItems.sort((a, b) => b.completed - a.completed || b.createdAt - a.createdAt);
                    break;
                default:
                    checklistItems.sort((a, b) => b.createdAt - a.createdAt); // Default to recent
            }
        }
        
        function updateActiveSortButton() {
            document.querySelectorAll('#checklistSortButtons .button').forEach(button => {
                button.classList.toggle('active', button.dataset.sort === currentChecklistSort);
            });
        }


        function renderChecklistItems() {
            if (!domElements.checklistItemsContainer) return;
            sortChecklistItems(); // Sort before rendering
            domElements.checklistItemsContainer.innerHTML = '';
            checklistItems.forEach(item => {
                const listItemDiv = document.createElement('div'); 
                listItemDiv.className = 'list-item checklist-item';  
                listItemDiv.dataset.id = item.id;

                const mainContentDiv = document.createElement('div');
                mainContentDiv.className = 'list-item-main-content';

                const contentDiv = document.createElement('div'); 
                contentDiv.className = 'checklist-item-content';
                
                const checkboxPlaceholder = document.createElement('span'); 
                checkboxPlaceholder.className = 'checkbox-placeholder';
                checkboxPlaceholder.innerHTML = item.completed ? icons.checkboxChecked : icons.checkboxEmpty;
                checkboxPlaceholder.addEventListener('click', (e) => { 
                    e.stopPropagation(); 
                    toggleChecklistItemCompleted(item.id); 
                });

                const text = document.createElement('span'); 
                text.className = 'checklist-item-text';
                if (item.completed) text.classList.add('completed');
                text.textContent = item.text;
                
                contentDiv.appendChild(checkboxPlaceholder); 
                contentDiv.appendChild(text);
                contentDiv.addEventListener('click', () => toggleChecklistItemExpansion(item.id));


                const expandIcon = document.createElement('span');
                expandIcon.className = 'expand-icon-placeholder';
                expandIcon.innerHTML = item.isExpanded ? icons.chevronUp : icons.chevronDown;
                expandIcon.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleChecklistItemExpansion(item.id);
                });

                const deleteBtnPlaceholder = document.createElement('span'); 
                deleteBtnPlaceholder.className = 'delete-button-placeholder';
                deleteBtnPlaceholder.innerHTML = icons.trash;
                deleteBtnPlaceholder.addEventListener('click', (e) => { e.stopPropagation(); deleteChecklistItem(item.id); });

                mainContentDiv.appendChild(contentDiv);
                mainContentDiv.appendChild(expandIcon);
                mainContentDiv.appendChild(deleteBtnPlaceholder);
                
                const descriptionArea = document.createElement('div');
                descriptionArea.className = 'checklist-item-description-area';
                if (item.isExpanded) descriptionArea.classList.add('expanded');
                
                const descriptionTextarea = document.createElement('textarea');
                descriptionTextarea.className = 'textarea-input';
                descriptionTextarea.placeholder = 'Ajouter une description ou des notes...';
                descriptionTextarea.value = item.description || '';
                descriptionTextarea.addEventListener('change', (e) => {
                    updateChecklistItemDescription(item.id, e.target.value);
                });
                descriptionArea.appendChild(descriptionTextarea);

                listItemDiv.appendChild(mainContentDiv);
                listItemDiv.appendChild(descriptionArea);
                domElements.checklistItemsContainer.appendChild(listItemDiv);
            });
            updateActiveSortButton();
        }

        function toggleChecklistItemCompleted(id) { 
            const item = checklistItems.find(i => i.id === id); 
            if (item) { 
                item.completed = !item.completed; 
                renderChecklistItems(); 
                saveData(); 
            }
        }
        function toggleChecklistItemExpansion(id) {
            const item = checklistItems.find(i => i.id === id);
            if (item) {
                item.isExpanded = !item.isExpanded;
                renderChecklistItems(); 
                saveData();
            }
        }
        function updateChecklistItemDescription(id, description) {
            const item = checklistItems.find(i => i.id === id);
            if (item) {
                item.description = description;
                saveData(); 
            }
        }

        function deleteChecklistItem(id) { 
            checklistItems = checklistItems.filter(i => i.id !== id); 
            renderChecklistItems(); 
            saveData(); 
        }
        function addChecklistItem() {
            const text = domElements.newItemInput.value.trim(); if (text === '') return;
            checklistItems.push({ id: generateId('checklist'), text: text, completed: false, description: '', isExpanded: false, createdAt: Date.now() });
            domElements.newItemInput.value = ''; 
            renderChecklistItems(); 
            saveData();
        }
        domElements.addItemButton.addEventListener('click', addChecklistItem);
        domElements.newItemInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') addChecklistItem(); });
        
        async function suggestNewTasks() {
            const existingTasksText = checklistItems.map(item => `- ${item.text}`).join('\n');
            const prompt = `Je planifie un voyage au Japon. Ma checklist actuelle:\n${existingTasksText}\n\nSugg√®re 3 t√¢ches de pr√©paration importantes et concises pour un voyage au Japon. Ne r√©p√®te pas les t√¢ches existantes. Une t√¢che par ligne, sans tiret ni num√©rotation.`;
            try {
                const suggestionsText = await generateContentWithGemini(prompt);
                suggestionsText.split('\n').filter(task => task.trim() !== '').forEach(taskText => {
                    if (!checklistItems.some(item => item.text.toLowerCase() === taskText.toLowerCase().trim())) {
                        checklistItems.push({ id: generateId('checklist-ai'), text: taskText.trim(), completed: false, isAISuggestion: true, description: '', isExpanded: false, createdAt: Date.now() });
                    }
                });
                renderChecklistItems(); saveData();
            } catch (error) { console.error("Erreur suggestion t√¢ches:", error); }
        }
        domElements.suggestTasksButton.addEventListener('click', suggestNewTasks);
        if (domElements.checklistSortButtonsContainer) {
            domElements.checklistSortButtonsContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('button')) {
                    currentChecklistSort = e.target.dataset.sort;
                    renderChecklistItems();
                }
            });
        }


        // --- Villes & Activit√©s Fonctions ---
        function openEditCityModal(cityId) {
            const city = citiesData.find(c => c.id === cityId);
            if (!city) return;
            domElements.editingCityIdModalInput.value = city.id;
            domElements.cityNameModalInput.value = city.name;
            domElements.cityColorModalInputHidden.value = city.color || '#808080'; 
            
            domElements.cityColorPaletteDiv.innerHTML = '';
            cityColorPalette.forEach(color => {
                const colorDiv = document.createElement('div');
                colorDiv.className = 'color-option';
                colorDiv.style.backgroundColor = color.value;
                colorDiv.dataset.colorValue = color.value;
                colorDiv.title = color.name; 
                if (color.value === (city.color || '#808080')) {
                    colorDiv.classList.add('selected');
                }
                colorDiv.addEventListener('click', () => {
                    document.querySelectorAll('#cityColorPalette .color-option').forEach(opt => opt.classList.remove('selected'));
                    colorDiv.classList.add('selected');
                    domElements.cityColorModalInputHidden.value = color.value;
                });
                domElements.cityColorPaletteDiv.appendChild(colorDiv);
            });

            domElements.editCityModal.style.display = 'block';
        }

        function closeEditCityModal() {
            domElements.editCityModal.style.display = 'none';
        }

        function saveCityDetails() {
            const cityId = domElements.editingCityIdModalInput.value;
            const newName = domElements.cityNameModalInput.value.trim();
            const newColor = domElements.cityColorModalInputHidden.value;

            if (!newName) {
                showErrorMessage("Le nom de la ville ne peut pas √™tre vide.");
                return;
            }
            const city = citiesData.find(c => c.id === cityId);
            if (city) {
                city.name = newName;
                city.color = newColor || '#808080';
                renderCities();
                populateItineraryCitySelect();
                renderItinerary(); 
                saveData();
            }
            closeEditCityModal();
        }


        function renderCities() {
            if (!domElements.citiesListContainer) return;
            domElements.citiesListContainer.innerHTML = '';
            citiesData.forEach(city => {
                const cityCard = document.createElement('div'); cityCard.className = 'city-container'; cityCard.dataset.id = city.id;
                const header = document.createElement('div'); header.className = 'city-header';
                const headerMain = document.createElement('div'); headerMain.className = 'city-header-main';
                
                const colorIndicator = document.createElement('span');
                colorIndicator.className = 'city-color-indicator';
                colorIndicator.style.backgroundColor = city.color || 'var(--tertiary-bg-color)';
                headerMain.appendChild(colorIndicator);
                
                const cityNameSpan = document.createElement('span');
                cityNameSpan.className = 'city-name';
                cityNameSpan.textContent = city.name;
                headerMain.appendChild(cityNameSpan);

                const expandIconPlaceholder = document.createElement('span'); expandIconPlaceholder.className = 'city-expand-icon-placeholder';
                expandIconPlaceholder.innerHTML = city.isExpanded ? icons.minus : icons.plus;
                headerMain.appendChild(expandIconPlaceholder);
                headerMain.addEventListener('click', () => { city.isExpanded = !city.isExpanded; renderCities(); saveData(); });
                
                const cityActionsDiv = document.createElement('div'); cityActionsDiv.className = 'city-actions';
                
                const editCityButton = document.createElement('button');
                editCityButton.className = 'button city-edit-button city-action-button';
                editCityButton.innerHTML = icons.edit + ' Modifier';
                editCityButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openEditCityModal(city.id);
                });
                cityActionsDiv.appendChild(editCityButton);

                const aiButton = document.createElement('button'); aiButton.className = 'button city-ai-button city-action-button';
                aiButton.innerHTML = icons.sparkle + ' Id√©es Activit√©s';
                aiButton.addEventListener('click', (e) => { e.stopPropagation(); suggestCityAttractions(city.id); });
                cityActionsDiv.appendChild(aiButton);
                
                const suggestFoodButton = document.createElement('button');
                suggestFoodButton.className = 'button suggest-food-button city-action-button'; 
                // suggestFoodButton.style.backgroundColor = '#c0392b'; // Color now handled by theme CSS
                suggestFoodButton.innerHTML = icons.food + ' Restaurants';
                suggestFoodButton.addEventListener('click', (e) => { e.stopPropagation(); suggestFoodForCity(city.id); });
                cityActionsDiv.appendChild(suggestFoodButton);


                const deleteCityBtnPlaceholder = document.createElement('span'); deleteCityBtnPlaceholder.className = 'delete-button-placeholder delete-city-button-placeholder';
                deleteCityBtnPlaceholder.innerHTML = icons.trash;
                deleteCityBtnPlaceholder.addEventListener('click', (e) => { e.stopPropagation(); deleteCity(city.id); });
                
                cityActionsDiv.appendChild(deleteCityBtnPlaceholder);
                header.appendChild(headerMain); header.appendChild(cityActionsDiv);
                
                const attractionsContainer = document.createElement('div'); attractionsContainer.className = 'attractions-container';
                if (city.isExpanded) {
                    attractionsContainer.classList.add('expanded');
                    const attractionsByCategory = (city.attractions || []).reduce((acc, attraction) => {
                        const category = attraction.category || 'Autres';
                        if (!acc[category]) acc[category] = []; acc[category].push(attraction); return acc;
                    }, {});

                    Object.keys(attractionsByCategory).sort().forEach(category => {
                        const categoryDiv = document.createElement('div'); categoryDiv.className = 'attraction-category';
                        const categoryTitle = document.createElement('h3'); categoryTitle.className = 'attraction-category-title'; 
                        
                        const categoryStyle = activityCategoryStyles[category] || activityCategoryStyles["Autre"];
                        const categoryColorIndicator = document.createElement('span');
                        categoryColorIndicator.className = 'category-color-indicator';
                        categoryColorIndicator.style.backgroundColor = categoryStyle.color;
                        categoryTitle.appendChild(categoryColorIndicator);
                        categoryTitle.appendChild(document.createTextNode(category)); 
                        
                        categoryDiv.appendChild(categoryTitle);
                        
                        attractionsByCategory[category].sort((a,b) => a.text.localeCompare(b.text)).forEach(attraction => {
                            const attractionItemWrapper = document.createElement('div');
                            attractionItemWrapper.className = 'attraction-item-wrapper';
                            attractionItemWrapper.dataset.id = attraction.id;

                            const checkboxPlaceholder = document.createElement('span'); 
                            checkboxPlaceholder.className = 'attraction-checkbox-placeholder';
                            checkboxPlaceholder.innerHTML = attraction.completed ? icons.checkboxChecked : icons.checkboxEmpty;
                            checkboxPlaceholder.addEventListener('click', (e) => {
                                e.stopPropagation();
                                toggleCityAttractionCompleted(city.id, attraction.id);
                            });
                            
                            const contentDiv = document.createElement('div');
                            contentDiv.className = 'attraction-content';

                            const textSpan = document.createElement('span'); 
                            textSpan.className = 'attraction-text';
                            if (attraction.completed) textSpan.classList.add('completed');
                            if (attraction.isAISuggestion) textSpan.classList.add('ai-suggestion'); 
                            textSpan.textContent = attraction.text.replace(/\*\*/g, ''); 
                            textSpan.addEventListener('click', () => toggleCityAttractionCompleted(city.id, attraction.id));
                            contentDiv.appendChild(textSpan);

                            if (attraction.description) {
                                const descriptionP = document.createElement('p');
                                descriptionP.className = 'attraction-description';
                                descriptionP.textContent = attraction.description;
                                contentDiv.appendChild(descriptionP);
                            }
                            
                            if (attraction.price) {
                                const priceSpan = document.createElement('span'); 
                                priceSpan.className = 'attraction-price';
                                priceSpan.textContent = `(${attraction.price})`; 
                                contentDiv.appendChild(priceSpan);
                            }

                            const mapButton = document.createElement('button');
                            mapButton.className = 'map-link-button';
                            mapButton.innerHTML = icons.mapMarker + ' Maps';
                            mapButton.addEventListener('click', (e) => {
                                e.stopPropagation();
                                const query = encodeURIComponent(`${attraction.text.replace(/\*\*/g, '')}, ${city.name}, Japon`);
                                window.open(`https://www.google.com/maps/search/?api=1&query=${query}`, '_blank'); 
                            });
                            contentDiv.appendChild(mapButton);
                            
                            const actionsDiv = document.createElement('div');
                            actionsDiv.className = 'attraction-actions';
                            const deleteAttractionBtn = document.createElement('span'); 
                            deleteAttractionBtn.className = 'delete-button-placeholder delete-attraction-button-placeholder';
                            deleteAttractionBtn.innerHTML = icons.trash;
                            deleteAttractionBtn.addEventListener('click', (e) => { e.stopPropagation(); deleteCityAttraction(city.id, attraction.id); });
                            actionsDiv.appendChild(deleteAttractionBtn);

                            attractionItemWrapper.appendChild(checkboxPlaceholder);
                            attractionItemWrapper.appendChild(contentDiv);
                            attractionItemWrapper.appendChild(actionsDiv);
                            categoryDiv.appendChild(attractionItemWrapper);
                        });
                        attractionsContainer.appendChild(categoryDiv);
                    });

                    const addAttractionTitle = document.createElement('h4');
                    addAttractionTitle.className = 'add-attraction-section-title';
                    addAttractionTitle.textContent = 'Ajouter une nouvelle activit√©';
                    attractionsContainer.appendChild(addAttractionTitle);
                    
                    const addAttractionDiv = document.createElement('div');
                    addAttractionDiv.className = 'add-attraction-form';
                    addAttractionDiv.innerHTML = `
                        <input type="text" class="text-input new-attraction-text-${city.id}" placeholder="Nom de l'activit√©...">
                        <textarea class="textarea-input new-attraction-description-${city.id}" placeholder="Courte description..."></textarea>
                        <input type="text" class="text-input new-attraction-category-${city.id}" placeholder="Cat√©gorie (ex: Culturel)...">
                        <input type="text" class="text-input new-attraction-price-${city.id}" placeholder="Prix (ex: ¬•¬•, Gratuit)...">
                    `;
                    const addManualActivityBtn = document.createElement('button');
                    addManualActivityBtn.className = 'button add-button small-button';
                    addManualActivityBtn.textContent = 'Ajouter Activit√©';
                    addManualActivityBtn.addEventListener('click', () => addManualActivityToCity(city.id));
                    addAttractionDiv.appendChild(addManualActivityBtn);
                    attractionsContainer.appendChild(addAttractionDiv);
                }
                cityCard.appendChild(header); cityCard.appendChild(attractionsContainer);
                domElements.citiesListContainer.appendChild(cityCard);
            });
        }
        
        function addManualActivityToCity(cityId) {
            const city = citiesData.find(c => c.id === cityId);
            if (!city) return;

            const textInput = document.querySelector(`.new-attraction-text-${cityId}`);
            const descriptionInput = document.querySelector(`.new-attraction-description-${cityId}`);
            const categoryInput = document.querySelector(`.new-attraction-category-${cityId}`);
            const priceInput = document.querySelector(`.new-attraction-price-${cityId}`);

            const text = textInput.value.trim();
            const description = descriptionInput.value.trim();
            const category = categoryInput.value.trim() || 'Autre';
            const price = priceInput.value.trim() || 'N/A';

            if (text === '') {
                showErrorMessage("Le nom de l'activit√© est requis.");
                return;
            }

            if (!city.attractions) city.attractions = [];
            city.attractions.push({
                id: generateId('attr-manual'),
                text,
                description,
                category,
                price,
                completed: false,
                isAISuggestion: false
            });

            textInput.value = '';
            descriptionInput.value = '';
            categoryInput.value = '';
            priceInput.value = '';
            renderCities();
            saveData();
        }

        function getRandomColor() {
            return cityColorPalette[Math.floor(Math.random() * cityColorPalette.length)].value;
        }


        function addCity() { 
            const cityName = domElements.newCityInput.value.trim();
            if (cityName === '') { showErrorMessage("Le nom de la ville est requis."); return; }
            if (citiesData.some(city => city.name.toLowerCase() === cityName.toLowerCase())) { showErrorMessage("Cette ville existe d√©j√†."); return; }
            citiesData.push({ id: generateId('city'), name: cityName, color: getRandomColor(), isExpanded: false, attractions: [] });
            domElements.newCityInput.value = ''; 
            renderCities(); 
            populateItineraryCitySelect(); 
            saveData();
        }
        domElements.addCityButton.addEventListener('click', addCity);
        domElements.newCityInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') addCity(); });
        
        function deleteCity(cityId) { 
            citiesData = citiesData.filter(city => city.id !== cityId); 
            itineraryData = itineraryData.filter(stop => stop.cityId !== cityId);
            renderCities(); 
            renderItinerary();
            populateItineraryCitySelect();
            saveData(); 
        }
        
        function toggleCityAttractionCompleted(cityId, attractionId) {
             const city = citiesData.find(c => c.id === cityId);
            if (city) { 
                const attraction = (city.attractions || []).find(a => a.id === attractionId); 
                if (attraction) { 
                    attraction.completed = !attraction.completed; 
                    renderCities(); 
                    saveData(); 
                }
            }
        }
        function deleteCityAttraction(cityId, attractionId) {
            const city = citiesData.find(c => c.id === cityId);
            if (city) { 
                city.attractions = (city.attractions || []).filter(a => a.id !== attractionId); 
                renderCities(); 
                saveData(); 
            }
        }
        async function suggestCityAttractions(cityId) { 
            const city = citiesData.find(c => c.id === cityId); if (!city) return;

            let durationInCity = 3; 
            const itineraryStop = itineraryData.find(stop => stop.cityId === cityId);
            if (itineraryStop) {
                durationInCity = parseInt(itineraryStop.durationNights) + 1; 
            }
            
            let numberOfSuggestions = 3; 
            if (durationInCity <= 2) numberOfSuggestions = 2;
            else if (durationInCity >= 5) numberOfSuggestions = 4;


            const existingAttractionsText = (city.attractions || []).filter(attr => attr.category !== "Nourriture & Restaurants").map(attr => `- ${attr.text}`).join('\n');
            const prompt = `Pour la ville de ${city.name} au Japon, o√π je pr√©vois de rester environ ${durationInCity} jours, sugg√®re ${numberOfSuggestions} activit√©s ou lieux touristiques int√©ressants (pas de restaurants ou nourriture ici), en plus de ceux-ci (s'il y en a):\n${existingAttractionsText}\n\nPour chaque suggestion, donne le nom, une cat√©gorie (ex: Culturel, Nature, Shopping, Point d'int√©r√™t, Monument), une estimation de prix (Gratuit, ¬•, ¬•¬•, ¬•¬•¬•, ou N/A), et une tr√®s courte description (max 15 mots).
Ne r√©p√®te pas les attractions existantes. R√©ponds uniquement avec les suggestions au format exact (une par ligne): NOM_ATTRACTION;CATEGORIE;PRIX;DESCRIPTION_COURTE. N'utilise pas de formatage markdown comme des ast√©risques.
Exemple: Temple Senso-ji;Culturel;Gratuit;Plus ancien temple de Tokyo.`;
            try {
                const suggestionsText = await generateContentWithGemini(prompt);
                if (!city.attractions) city.attractions = [];
                suggestionsText.split('\n').filter(attr => attr.trim() !== '' && attr.includes(';')).forEach(rawAttrText => {
                    const parts = rawAttrText.split(';');
                    if (parts.length >= 4) { 
                        const text = parts[0]?.trim().replace(/\*\*/g, ''); 
                        const category = parts[1]?.trim() || "Suggestion";
                        const price = parts[2]?.trim() || "N/A";
                        const description = parts[3]?.trim() || "";
                        if (text && !city.attractions.some(ea => ea.text.toLowerCase().includes(text.toLowerCase()))) {
                            city.attractions.push({ id: generateId('attr-ai'), text, category, price, description, completed: false, isAISuggestion: true });
                        }
                    }
                });
                if (!city.isExpanded) city.isExpanded = true; 
                renderCities(); 
                saveData();
            } catch (error) { console.error(`Erreur suggestion pour ${city.name}:`, error); }
        }

        async function suggestFoodForCity(cityId) {
            const city = citiesData.find(c => c.id === cityId); if (!city) return;
            const existingFoodText = (city.attractions || []).filter(attr => attr.category === "Nourriture & Restaurants").map(attr => `- ${attr.text}`).join('\n');
            const prompt = `Pour la ville de ${city.name} au Japon, sugg√®re 2-3 sp√©cialit√©s culinaires locales ou des types de restaurants √† essayer. Pour chaque suggestion, donne le nom et une br√®ve description (max 10 mots). Ne r√©p√®te pas ce qui existe d√©j√† :\n${existingFoodText}\nR√©ponds uniquement avec les suggestions au format : NOM_SPECIALITE_OU_TYPE_RESTAURANT;DESCRIPTION_COURTE. N'utilise pas de formatage markdown comme des ast√©risques.`;
            
            try {
                const suggestionsText = await generateContentWithGemini(prompt);
                if (!city.attractions) city.attractions = [];
                suggestionsText.split('\n').filter(line => line.trim() !== '' && line.includes(';')).forEach(rawLine => {
                    const parts = rawLine.split(';');
                    if (parts.length >= 2) {
                        const text = parts[0]?.trim().replace(/\*\*/g, ''); 
                        const description = parts[1]?.trim() || "";
                        if (text && !city.attractions.some(ea => ea.text.toLowerCase().includes(text.toLowerCase()) && ea.category === "Nourriture & Restaurants")) {
                            city.attractions.push({
                                id: generateId('food-ai'),
                                text,
                                category: "Nourriture & Restaurants",
                                price: "Variable", 
                                description,
                                completed: false,
                                isAISuggestion: true
                            });
                        }
                    }
                });
                if (!city.isExpanded) city.isExpanded = true;
                renderCities();
                saveData();
            } catch (error) { console.error(`Erreur suggestion nourriture pour ${city.name}:`, error); }
        }
        
        // --- Itinerary Functions ---
        function renderItineraryPath() {
            if (!domElements.itineraryPathContainer) return;
            domElements.itineraryPathContainer.innerHTML = '';
            const sortedItinerary = [...itineraryData].sort((a, b) => new Date(a.startDate) - new Date(b.startDate));

            if (sortedItinerary.length === 0) {
                domElements.itineraryPathContainer.innerHTML = '<p style="text-align:center; font-size:14px; color: var(--text-color-tertiary);">Aucune √©tape dans l\'itin√©raire.</p>';
                return;
            }
            
            sortedItinerary.forEach((stop, index) => {
                const city = citiesData.find(c => c.id === stop.cityId);
                if (!city) return;

                const pathItem = document.createElement('span');
                pathItem.className = 'itinerary-path-item';
                pathItem.style.backgroundColor = city.color || 'var(--tertiary-bg-color)';
                pathItem.textContent = city.name;
                domElements.itineraryPathContainer.appendChild(pathItem);

                if (index < sortedItinerary.length - 1) {
                    const arrowSpan = document.createElement('span');
                    arrowSpan.innerHTML = icons.route; 
                    arrowSpan.style.color = 'var(--text-color-tertiary)';
                    arrowSpan.style.margin = '0 5px';
                    domElements.itineraryPathContainer.appendChild(arrowSpan);
                }
            });
        }


        function populateItineraryCitySelect() {
            if (!domElements.itineraryCitySelect) return;
            const currentSelection = domElements.itineraryCitySelect.value;
            domElements.itineraryCitySelect.innerHTML = '<option value="">-- Choisir une ville --</option>';
            citiesData.forEach(city => {
                const option = document.createElement('option');
                option.value = city.id;
                option.textContent = city.name;
                if (city.id === currentSelection) option.selected = true;
                domElements.itineraryCitySelect.appendChild(option);
            });
        }
        
        function parseGeminiCostResponse(responseText) {
            if (!responseText) return 0;
            const cleanedText = responseText.replace(/[¬•ÂÜÜÔø•,]/g, '').trim();
            const rangeMatch = cleanedText.match(/^(\d+)\s*-\s*(\d+)$/);
            if (rangeMatch) {
                const num1 = parseInt(rangeMatch[1], 10);
                const num2 = parseInt(rangeMatch[2], 10);
                if (!isNaN(num1) && !isNaN(num2)) {
                    return Math.round((num1 + num2) / 2);
                }
            }
            const singleNumberMatch = cleanedText.match(/^(\d+)$/);
            if (singleNumberMatch) {
                const num = parseInt(singleNumberMatch[1], 10);
                if (!isNaN(num)) return num;
            }
            const anyNumberMatch = cleanedText.match(/\d+/);
            if (anyNumberMatch) {
                 const num = parseInt(anyNumberMatch[0], 10);
                 if (!isNaN(num)) return num;
            }
            console.warn("Could not parse cost from Gemini response:", responseText);
            return 0; 
        }


        async function getTrainCostEstimateAI(city1Name, city2Name, elementToUpdate) { 
            if (city1Name === city2Name) return 0; 

            const cacheKey = `trainCost-${[city1Name, city2Name].sort().join('-')}`;
            const cachedItem = localStorage.getItem(cacheKey);
            if (cachedItem) {
                const {cost, timestamp} = JSON.parse(cachedItem);
                if (Date.now() - timestamp < 24 * 60 * 60 * 1000) { 
                    if (elementToUpdate) elementToUpdate.textContent = `Train depuis ${city1Name}: env. ¬•${cost.toLocaleString()}`;
                    return cost;
                }
            }

            const prompt = `Estime le co√ªt moyen en Yens d'un billet de train pour un adulte entre ${city1Name} et ${city2Name} au Japon. Si c'est un trajet typiquement fait en Shinkansen, base-toi sur cela. R√©ponds uniquement avec un nombre (par exemple, 14500) ou une fourchette de nombres (par exemple, 12000-15000). N'ajoute aucun texte explicatif.`;
            try {
                if (elementToUpdate) elementToUpdate.textContent = `Train depuis ${city1Name}: Estimation...`;
                
                const responseText = await generateContentWithGemini(prompt); 
                const cost = parseGeminiCostResponse(responseText);
                
                if (cost > 0) {
                    localStorage.setItem(cacheKey, JSON.stringify({cost, timestamp: Date.now()})); 
                }
                 if (elementToUpdate) elementToUpdate.textContent = cost > 0 ? `Train depuis ${city1Name}: env. ¬•${cost.toLocaleString()}` : `Train depuis ${city1Name}: Co√ªt non estim√©`;
                return cost;
            } catch (error) {
                console.error(`Erreur d'estimation du co√ªt du train pour ${city1Name} - ${city2Name}:`, error);
                if (elementToUpdate) elementToUpdate.textContent = `Train depuis ${city1Name}: Erreur estim.`;
                return 0; 
            }
        }
        
        async function renderItinerary() { 
            if (!domElements.itineraryTimelineContainer) return;
            renderItineraryPath(); 
            domElements.itineraryTimelineContainer.innerHTML = '';
            
            const sortedItinerary = [...itineraryData].sort((a, b) => new Date(a.startDate) - new Date(b.startDate));

            if (sortedItinerary.length === 0) {
                domElements.itineraryTimelineContainer.innerHTML = '<p style="text-align:center; color: var(--text-color-tertiary);">Commencez √† planifier votre itin√©raire !</p>';
                return;
            }

            for (let index = 0; index < sortedItinerary.length; index++) { 
                const stop = sortedItinerary[index];
                const city = citiesData.find(c => c.id === stop.cityId);
                if (!city) continue; 

                const itemDiv = document.createElement('div');
                itemDiv.className = 'timeline-item';

                const reorderDiv = document.createElement('div'); 
                reorderDiv.className = 'reorder-buttons';
                if (index > 0) { 
                    const upButton = document.createElement('button');
                    upButton.innerHTML = icons.arrowUp;
                    upButton.title = "Monter l'√©tape";
                    upButton.addEventListener('click', () => moveItineraryStop(index, index - 1));
                    reorderDiv.appendChild(upButton);
                }
                if (index < sortedItinerary.length - 1) { 
                     const downButton = document.createElement('button');
                    downButton.innerHTML = icons.chevronDown; 
                    downButton.title = "Descendre l'√©tape";
                    downButton.addEventListener('click', () => moveItineraryStop(index, index + 1));
                    reorderDiv.appendChild(downButton);
                }
                itemDiv.appendChild(reorderDiv); 

                const dotDiv = document.createElement('div');
                dotDiv.className = 'timeline-dot';
                dotDiv.style.backgroundColor = city.color || 'var(--accent-color)'; 
                itemDiv.appendChild(dotDiv);

                const contentDiv = document.createElement('div');
                contentDiv.className = 'timeline-item-content';

                const cityP = document.createElement('p');
                cityP.className = 'timeline-city';
                cityP.textContent = city.name;
                cityP.style.color = city.color || 'var(--text-color-primary)'; 
                contentDiv.appendChild(cityP);

                const startDate = new Date(stop.startDate + 'T00:00:00'); 
                const endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + parseInt(stop.durationNights));
                
                const datesP = document.createElement('p');
                datesP.className = 'timeline-dates';
                datesP.innerHTML = `${icons.calendar} ${startDate.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' })} - ${endDate.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short', year: 'numeric' })}`;
                contentDiv.appendChild(datesP);
                
                const durationP = document.createElement('p');
                durationP.className = 'timeline-duration';
                durationP.textContent = `${stop.durationNights} nuit(s)`;
                contentDiv.appendChild(durationP);

                if (stop.notes) {
                    const notesP = document.createElement('p');
                    notesP.className = 'timeline-notes';
                    notesP.textContent = `Notes: ${stop.notes}`;
                    contentDiv.appendChild(notesP);
                }

                if (index > 0) {
                    const prevStop = sortedItinerary[index - 1];
                    const prevCity = citiesData.find(c => c.id === prevStop.cityId);
                    if (prevCity && prevCity.name !== city.name) {
                        const trainCostP = document.createElement('p');
                        trainCostP.className = 'timeline-train-cost';
                        trainCostP.id = `trainCost-${prevCity.id}-${city.id}-${stop.id}`; 
                        trainCostP.textContent = `Train depuis ${prevCity.name}: Estimation...`;
                        contentDiv.appendChild(trainCostP);
                        getTrainCostEstimateAI(prevCity.name, city.name, trainCostP); 
                    }
                }
                
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'timeline-item-actions';
                
                const editStopBtn = document.createElement('button');
                editStopBtn.className = 'button small-button secondary-button';
                editStopBtn.innerHTML = icons.edit + " Modifier";
                editStopBtn.addEventListener('click', () => populateItineraryFormForEdit(stop.id));
                actionsDiv.appendChild(editStopBtn);

                const deleteStopBtn = document.createElement('button');
                deleteStopBtn.className = 'button small-button destructive-color'; 
                deleteStopBtn.style.backgroundColor = 'var(--destructive-color)';
                deleteStopBtn.innerHTML = icons.trash + " Supprimer";
                deleteStopBtn.addEventListener('click', () => deleteItineraryStop(stop.id));
                actionsDiv.appendChild(deleteStopBtn);
                contentDiv.appendChild(actionsDiv);

                itemDiv.appendChild(contentDiv);
                domElements.itineraryTimelineContainer.appendChild(itemDiv);
            }
        }

        function moveItineraryStop(oldIndexSorted, newIndexSorted) {
            const sortedItinerary = [...itineraryData].sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
            const itemToMoveId = sortedItinerary[oldIndexSorted].id;
            
            const itemToMoveOriginalIndex = itineraryData.findIndex(item => item.id === itemToMoveId);
            if (itemToMoveOriginalIndex === -1) return;

            const item = itineraryData.splice(itemToMoveOriginalIndex, 1)[0]; 
            
            let newOriginalIndex = 0;
            if (newIndexSorted < oldIndexSorted) { 
                if (newIndexSorted === 0) {
                    newOriginalIndex = 0;
                } else {
                    const itemBeforeTargetId = sortedItinerary[newIndexSorted -1].id;
                    newOriginalIndex = itineraryData.findIndex(it => it.id === itemBeforeTargetId) + 1;
                }
            } else { 
                 if (newIndexSorted >= itineraryData.length) { 
                    newOriginalIndex = itineraryData.length;
                 } else {
                    const itemAtTargetId = sortedItinerary[newIndexSorted].id; 
                    newOriginalIndex = itineraryData.findIndex(it => it.id === itemAtTargetId);
                 }
            }
            itineraryData.splice(newOriginalIndex, 0, item); 

            renderItinerary();
            saveData();
        }
        
        function populateItineraryFormForEdit(stopId) {
            const stopToEdit = itineraryData.find(stop => stop.id === stopId);
            if (!stopToEdit) return;

            editingItineraryStopId = stopId;
            domElements.editingItineraryStopIdInput.value = stopId;
            domElements.itineraryCitySelect.value = stopToEdit.cityId;
            domElements.itineraryStartDateInput.value = stopToEdit.startDate;
            domElements.itineraryDurationNightsInput.value = stopToEdit.durationNights;
            domElements.itineraryNotesInput.value = stopToEdit.notes || '';
            
            domElements.addItineraryStopButton.textContent = 'Modifier √âtape';
            domElements.cancelEditItineraryButton.style.display = 'inline-flex';
        }

        function resetItineraryForm() {
            editingItineraryStopId = null;
            domElements.editingItineraryStopIdInput.value = '';
            domElements.itineraryForm.reset();
            
            const sortedItinerary = [...itineraryData].sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
            let nextStartDateStr = TRIP_START_DATE;
            if(sortedItinerary.length > 0) {
                const lastStop = sortedItinerary[sortedItinerary.length -1];
                const lastStopEndDate = new Date(lastStop.startDate + "T00:00:00"); // Ensure parsing as local date
                lastStopEndDate.setDate(lastStopEndDate.getDate() + parseInt(lastStop.durationNights));
                
                const tripEndDateObj = new Date(TRIP_END_DATE + "T00:00:00");
                if (lastStopEndDate <= tripEndDateObj) { 
                    nextStartDateStr = lastStopEndDate.toISOString().split('T')[0];
                } else {
                    nextStartDateStr = TRIP_END_DATE; 
                }
            }
            domElements.itineraryStartDateInput.value = nextStartDateStr;


            domElements.addItineraryStopButton.textContent = 'Ajouter √âtape';
            domElements.cancelEditItineraryButton.style.display = 'none';
            populateItineraryCitySelect(); 
        }


        function handleItineraryFormSubmit(event) {
            event.preventDefault();
            const cityId = domElements.itineraryCitySelect.value;
            const startDateStr = domElements.itineraryStartDateInput.value;
            const durationNights = parseInt(domElements.itineraryDurationNightsInput.value);
            const notes = domElements.itineraryNotesInput.value.trim();

            if (!cityId || !startDateStr || isNaN(durationNights) || durationNights < 1) {
                showErrorMessage("Veuillez remplir tous les champs requis pour l'√©tape.");
                return;
            }
            
            const newStopDate = new Date(startDateStr + 'T00:00:00'); 
            const tripStartDateObj = new Date(TRIP_START_DATE + 'T00:00:00');
            const tripEndDateObj = new Date(TRIP_END_DATE + 'T00:00:00');
            
            const tempEndDate = new Date(newStopDate);
            tempEndDate.setDate(newStopDate.getDate() + durationNights);

            if (newStopDate < tripStartDateObj || tempEndDate > new Date(tripEndDateObj.getTime() + (24*60*60*1000))) { 
                 showErrorMessage(`L'√©tape doit √™tre entre le ${tripStartDateObj.toLocaleDateString('fr-FR')} et le ${tripEndDateObj.toLocaleDateString('fr-FR')}.`);
                 return;
            }
            
            const otherStops = itineraryData.filter(s => s.id !== editingItineraryStopId); 
            for (const stop of otherStops) {
                const existingStartDate = new Date(stop.startDate + 'T00:00:00');
                const existingEndDate = new Date(existingStartDate);
                existingEndDate.setDate(existingStartDate.getDate() + parseInt(stop.durationNights));

                if (newStopDate < existingEndDate && tempEndDate > existingStartDate) {
                    showErrorMessage(`Cette p√©riode chevauche une √©tape existante pour ${citiesData.find(c=>c.id === stop.cityId)?.name || 'une ville'} (${existingStartDate.toLocaleDateString('fr-FR')} - ${existingEndDate.toLocaleDateString('fr-FR')}).`);
                    return;
                }
            }


            if (editingItineraryStopId) { 
                const stopIndex = itineraryData.findIndex(stop => stop.id === editingItineraryStopId);
                if (stopIndex > -1) {
                    itineraryData[stopIndex] = { ...itineraryData[stopIndex], cityId, startDate: startDateStr, durationNights, notes };
                }
            } else { 
                itineraryData.push({
                    id: generateId('itinerary'),
                    cityId,
                    startDate: startDateStr, 
                    durationNights,
                    notes
                });
            }
            
            renderItinerary();
            saveData();
            resetItineraryForm(); 
        }
        
        function deleteItineraryStop(stopId) {
            itineraryData = itineraryData.filter(stop => stop.id !== stopId);
            renderItinerary();
            saveData();
        }


        if (domElements.itineraryForm) {
            domElements.itineraryForm.addEventListener('submit', handleItineraryFormSubmit);
        }
        if (domElements.cancelEditItineraryButton) {
            domElements.cancelEditItineraryButton.addEventListener('click', resetItineraryForm);
        }
        
        // --- JR Pass Calculator ---
        async function calculateAndDisplayJrPassProfitability() { 
            if (!domElements.jrPassResultContainer) return;

            const sortedItinerary = [...itineraryData].sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
            if (sortedItinerary.length < 2) {
                domElements.jrPassResultContainer.innerHTML = "<p>Veuillez ajouter au moins deux √©tapes √† votre itin√©raire pour calculer la rentabilit√© du JR Pass.</p>";
                domElements.jrPassResultContainer.style.display = 'block';
                return;
            }
            
            showLoadingMessage("Calcul des co√ªts de train..."); 

            let totalIndividualCost = 0;
            const costPromises = [];

            for (let i = 0; i < sortedItinerary.length - 1; i++) {
                const city1Data = citiesData.find(c => c.id === sortedItinerary[i].cityId);
                const city2Data = citiesData.find(c => c.id === sortedItinerary[i+1].cityId);
                if (city1Data && city2Data && city1Data.name !== city2Data.name) { 
                    costPromises.push(getTrainCostEstimateAI(city1Data.name, city2Data.name, null)); 
                } else {
                    costPromises.push(Promise.resolve(0)); 
                }
            }
            
            try {
                const individualCosts = await Promise.all(costPromises);
                totalIndividualCost = individualCosts.reduce((sum, cost) => sum + cost, 0);
                hideLoadingMessage(); 
            } catch (error) {
                hideLoadingMessage();
                showErrorMessage("Erreur lors de l'estimation des co√ªts de train.");
                console.error("Error fetching all train costs for JR Pass:", error);
                return;
            }

            let resultsHTML = `<p><strong>Co√ªt total estim√© des billets individuels :</strong> ¬•${totalIndividualCost.toLocaleString()}</p>`;
            resultsHTML += `<p><strong>Comparaison avec les JR Pass (prix affich√©s ci-dessus) :</strong></p><ul>`;

            let bestPassOption = { days: 0, savings: -Infinity, price: Infinity };
            
            const firstDay = new Date(sortedItinerary[0].startDate + "T00:00:00");
            const lastStop = sortedItinerary[sortedItinerary.length - 1];
            const lastDayItinerary = new Date(lastStop.startDate + "T00:00:00");
            lastDayItinerary.setDate(lastDayItinerary.getDate() + parseInt(lastStop.durationNights));
            const mainTravelDuration = Math.ceil((lastDayItinerary - firstDay) / (1000 * 60 * 60 * 24)) +1; 


            Object.entries(jrPassPrices).forEach(([days, price]) => {
                const difference = totalIndividualCost - price;
                const isProfitable = difference > 0;
                resultsHTML += `<li>JR Pass ${days} jours : ¬•${price.toLocaleString()}. 
                                ${isProfitable ? '<strong style="color:var(--highlight-color);">Rentable</strong>' : 'Non rentable'}. 
                                ${isProfitable ? '√âconomie estim√©e' : 'Surco√ªt'}: ¬•${Math.abs(difference).toLocaleString()}
                               </li>`;
                if (isProfitable && difference > bestPassOption.savings) {
                    bestPassOption = {days: parseInt(days), savings: difference, price: price};
                } else if (!isProfitable && price < bestPassOption.price && bestPassOption.savings === -Infinity) {
                    bestPassOption = {days: parseInt(days), savings: difference, price: price};
                }
            });
            resultsHTML += `</ul>`;

            let recommendationText = "";
            if (bestPassOption.savings > 0) { 
                recommendationText = `Un JR Pass de ${bestPassOption.days} jours semble √™tre l'option la plus rentable, √©conomisant environ ¬•${bestPassOption.savings.toLocaleString()}.`;
                if (mainTravelDuration > bestPassOption.days) {
                    recommendationText += ` Votre p√©riode de voyage principale est d'environ ${mainTravelDuration} jours. Concentrez vos trajets les plus chers pendant la validit√© du pass de ${bestPassOption.days} jours.`;
                } else if (mainTravelDuration < bestPassOption.days && bestPassOption.days > 7) {
                    let shorterProfitablePass = null;
                    Object.entries(jrPassPrices).forEach(([daysStr, price]) => {
                        const days = parseInt(daysStr);
                        if (days < bestPassOption.days && (totalIndividualCost - price) > 0) {
                            if (!shorterProfitablePass || (totalIndividualCost - price) > (totalIndividualCost - jrPassPrices[shorterProfitablePass])) {
                                shorterProfitablePass = days;
                            }
                        }
                    });
                    if (shorterProfitablePass && mainTravelDuration <= shorterProfitablePass) {
                         recommendationText = `Un JR Pass de ${shorterProfitablePass} jours pourrait √™tre suffisant et rentable pour votre voyage de ${mainTravelDuration} jours, √©conomisant environ ¬•${(totalIndividualCost - jrPassPrices[shorterProfitablePass]).toLocaleString()}.`;
                    }
                }
                 resultsHTML += `<p class="recommendation profitable">${recommendationText}</p>`;
            } else { 
                recommendationText = "D'apr√®s cet itin√©raire, acheter des billets individuels semble plus √©conomique.";
                if (totalIndividualCost > 0 && bestPassOption.price !== Infinity) { 
                     recommendationText += ` Le pass le moins cher (${bestPassOption.days} jours √† ¬•${bestPassOption.price.toLocaleString()}) entra√Ænerait un surco√ªt d'environ ¬•${Math.abs(bestPassOption.savings).toLocaleString()}.`;
                }
                resultsHTML += `<p class="recommendation not-profitable">${recommendationText}</p>`;
            }
            
            resultsHTML += `<p class="info-small-text" style="margin-top:10px;">Note : Ces calculs sont bas√©s sur des estimations de prix pour les trajets principaux. Le JR Pass peut aussi couvrir certains trajets locaux sur les lignes JR, ce qui pourrait augmenter sa valeur.</p>`;
            
            domElements.jrPassResultContainer.innerHTML = resultsHTML;
            domElements.jrPassResultContainer.style.display = 'block';
        }


        // --- Info Screen Fonctions ---
        function updateConversionRateText() { if(domElements.conversionRateText) domElements.conversionRateText.textContent = `Taux : 1 EUR ‚âà ${currentExchangeRate} JPY`; }
        function convertCurrency() {
            const eurValue = parseFloat(domElements.eurInput.value);
            const jpyValue = parseFloat(domElements.jpyInput.value);
            if (document.activeElement === domElements.eurInput && !isNaN(eurValue)) domElements.jpyInput.value = (eurValue * currentExchangeRate).toFixed(0);
            else if (document.activeElement === domElements.jpyInput && !isNaN(jpyValue)) domElements.eurInput.value = (jpyValue / currentExchangeRate).toFixed(2);
        }
        if(domElements.eurInput) domElements.eurInput.addEventListener('input', convertCurrency);
        if(domElements.jpyInput) domElements.jpyInput.addEventListener('input', convertCurrency);

        function loadVoices() {
            try {
                const voices = speechSynthesis.getVoices();
                if (voices.length > 0) {
                    japaneseVoice = voices.find(voice => voice.lang === 'ja-JP');
                    if (!japaneseVoice) {
                        japaneseVoice = voices.find(voice => voice.lang.startsWith('ja'));
                    }
                    // console.log("Japanese voice selected:", japaneseVoice ? japaneseVoice.name : "None available after filtering");
                } else {
                    // console.log("Voice list empty, will retry on 'voiceschanged' or speak attempt.");
                }
            } catch (e) {
                console.error("Error loading voices:", e);
            }
        }


        function speak(text, lang = 'ja-JP') {
            if (!('speechSynthesis' in window)) {
                showErrorMessage("La synth√®se vocale n'est pas support√©e par votre navigateur.");
                return;
            }
            
            window.speechSynthesis.cancel(); 

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = lang;
            utterance.rate = 0.9;

            let voices = speechSynthesis.getVoices();
            if (voices.length === 0 && !japaneseVoice) { // If voices not loaded yet, try to load them
                console.log("Retrying to load voices for TTS...");
                speechSynthesis.onvoiceschanged = () => {
                    loadVoices(); // This will set japaneseVoice
                    if (japaneseVoice) utterance.voice = japaneseVoice;
                    else console.warn("Still no Japanese voice after retry.");
                    window.speechSynthesis.speak(utterance); // Speak after voices potentially loaded
                };
                // Some browsers (like Safari on iOS) might need a user gesture to trigger voice loading.
                // This is a fallback, usually onvoiceschanged in DOMContentLoaded is better.
                return; // Exit and wait for onvoiceschanged or next attempt
            }
            
            if (japaneseVoice) {
                utterance.voice = japaneseVoice;
            } else { // Fallback if japaneseVoice is still null
                let voiceToUse = voices.find(voice => voice.lang === lang);
                if (!voiceToUse) voiceToUse = voices.find(voice => voice.lang.startsWith('ja'));
                if (voiceToUse) utterance.voice = voiceToUse;
                else console.warn(`Aucune voix japonaise sp√©cifique trouv√©e pour TTS. Utilisation de la voix par d√©faut du navigateur pour ${lang}.`);
            }
            
            utterance.onerror = (event) => {
                console.error('Erreur de synth√®se vocale:', event.error, event);
                showErrorMessage(`Erreur de synth√®se vocale: ${event.error}`);
            };
            
            window.speechSynthesis.speak(utterance);
        }

        function renderUsefulWords() { 
            if (!domElements.usefulWordsListDiv) return;
            domElements.usefulWordsListDiv.innerHTML = ''; 
            usefulWords.forEach(word => {
                const p = document.createElement('p'); p.className = 'info-list-item'; p.dataset.id = word.id;
                if (word.isAISuggestion) p.classList.add('ai-suggestion');
                const textSpan = document.createElement('span'); textSpan.textContent = `‚Ä¢ ${word.text}: ${word.translation}`;
                const speakerIconPlaceholder = document.createElement('span'); speakerIconPlaceholder.className = 'speaker-icon-placeholder';
                speakerIconPlaceholder.innerHTML = icons.speaker;
                speakerIconPlaceholder.title = `√âcouter "${word.translation}"`;
                speakerIconPlaceholder.addEventListener('click', (e) => { e.stopPropagation(); speak(word.translation, word.lang); });
                p.appendChild(textSpan); p.appendChild(speakerIconPlaceholder);
                domElements.usefulWordsListDiv.appendChild(p);
            });
        }
        async function suggestNewWords() { 
             const existingWordsText = usefulWords.map(word => `- ${word.text}: ${word.translation}`).join('\n');
            const prompt = `Je planifie un voyage au Japon. Voici des mots/phrases que je connais d√©j√† :\n${existingWordsText}\n\nSugg√®re 3-5 autres mots ou courtes phrases japonaises utiles pour un touriste. Pour chaque suggestion:
1. Le terme en fran√ßais.
2. Sa traduction STRICTEMENT en caract√®res japonais (Hiragana, Katakana, Kanji uniquement - pas de romaji, pas de notes explicatives dans la traduction).
S√©pare le fran√ßais et le japonais par un DEUX-POINTS. Ne r√©p√®te pas les mots existants. R√©ponds uniquement avec les suggestions au format exact: TERME_FRANCAIS: TRADUCTION_JAPONAISE_PURE. N'utilise pas de formatage markdown comme des ast√©risques.
Exemple: O√π sont les toilettes ?: „Éà„Ç§„É¨„ÅØ„Å©„Åì„Åß„Åô„Åã`;
            try {
                const suggestionsText = await generateContentWithGemini(prompt);
                suggestionsText.split('\n').filter(line => line.trim() !== '' && line.includes(':')).forEach(rawLine => {
                    const parts = rawLine.split(':');
                    if (parts.length >= 2) {
                        const textFr = parts[0].trim().replace(/\*\*/g, '');
                        const translationJp = parts.slice(1).join(':').trim().replace(/\*\*/g, '');
                        if (textFr && translationJp && !usefulWords.some(w => w.text.toLowerCase() === textFr.toLowerCase() || w.translation.toLowerCase() === translationJp.toLowerCase())) {
                            usefulWords.push({ id: generateId('word-ai'), text: textFr, translation: translationJp, isAISuggestion: true, lang: 'ja-JP' });
                        }
                    }
                });
                renderUsefulWords(); saveData();
            } catch (error) { console.error("Erreur suggestion mots:", error); }
        }
        if(domElements.suggestWordsButton) domElements.suggestWordsButton.addEventListener('click', suggestNewWords);

        function applyTheme(themeNameInput) {
            let themeClass = themeNameInput;
            if (themeNameInput && !themeNameInput.startsWith('theme-')) { // Ensure "theme-" prefix if just name is passed
                themeClass = `theme-${themeNameInput}`;
            } else if (!themeNameInput) { // Fallback if undefined/null
                themeClass = 'theme-light';
            }
            
            domElements.body.className = ''; // Clear existing theme classes
            domElements.body.classList.add(themeClass); 
            localStorage.setItem('japanTripTheme', themeClass); 
        }


        function initIcons() {
            if(domElements.tabIconChecklist) domElements.tabIconChecklist.innerHTML = icons.checklist;
            if(domElements.tabIconCities) domElements.tabIconCities.innerHTML = icons.cities;
            if(domElements.tabIconItinerary) domElements.tabIconItinerary.innerHTML = icons.itinerary;
            if(domElements.tabIconInfo) domElements.tabIconInfo.innerHTML = icons.info;
            if(domElements.aiButtonSuggestTaskIconPlaceholder) domElements.aiButtonSuggestTaskIconPlaceholder.innerHTML = icons.sparkle;
            if(domElements.aiButtonSuggestWordIconPlaceholder) domElements.aiButtonSuggestWordIconPlaceholder.innerHTML = icons.sparkle;
        }

        document.addEventListener('DOMContentLoaded', () => {
            if ('speechSynthesis' in window) {
                if (speechSynthesis.getVoices().length === 0) {
                    speechSynthesis.onvoiceschanged = loadVoices;
                } else {
                    loadVoices(); 
                }
            }

            loadData(); // This now sets the default theme to 'theme-light' if nothing is saved
            
            initIcons(); 
            setActiveScreen('checklistScreen'); 
            
            renderChecklistItems();
            renderCities();
            renderUsefulWords(); 
            renderItinerary(); 
            
            populateItineraryCitySelect(); 
            if(domElements.itineraryStartDateInput) {
                domElements.itineraryStartDateInput.min = TRIP_START_DATE;
                domElements.itineraryStartDateInput.max = TRIP_END_DATE;
            }
            if(domElements.calculateJrPassButton) { 
                 domElements.calculateJrPassButton.addEventListener('click', calculateAndDisplayJrPassProfitability);
            }
            if(domElements.themeSelect) {
                domElements.themeSelect.addEventListener('change', (e) => applyTheme(e.target.value));
                const currentThemeClass = domElements.body.className;
                if (currentThemeClass.includes('theme-light')) domElements.themeSelect.value = 'light';
                else if (currentThemeClass.includes('theme-ocean-breeze')) domElements.themeSelect.value = 'ocean-breeze';
                else if (currentThemeClass.includes('theme-sakura-spring')) domElements.themeSelect.value = 'sakura-spring';
                else domElements.themeSelect.value = 'dark'; 
            }
            if (domElements.closeCityModalButton) domElements.closeCityModalButton.onclick = closeEditCityModal;
            if (domElements.saveCityModalButton) domElements.saveCityModalButton.onclick = saveCityDetails;
            window.onclick = function(event) { 
                if (event.target == domElements.editCityModal) {
                    closeEditCityModal();
                }
            }
            resetItineraryForm(); 

            updateConversionRateText();
        });
    </script>
</body>
</html>
